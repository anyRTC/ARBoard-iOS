/*!
  * ar-whiteboard v1.1.1
  * (c) 2023 anyRTC WhiteBoard SDK
  * @license MIT
  */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).self=t.self||{})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,o){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])},e(t,o)};function o(t,o){if("function"!=typeof o&&null!==o)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");function i(){this.constructor=t}e(t,o),t.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}var i=function(){return i=Object.assign||function(t){for(var e,o=1,i=arguments.length;o<i;o++)for(var r in e=arguments[o])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},i.apply(this,arguments)};function r(t,e,o,i){return new(o||(o=Promise))((function(r,n){function s(t){try{h(i.next(t))}catch(t){n(t)}}function a(t){try{h(i.throw(t))}catch(t){n(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(s,a)}h((i=i.apply(t,e||[])).next())}))}function n(t,e){var o,i,r,n,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(n){return function(a){return function(n){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(r=2&n[0]?i.return:n[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,n[1])).done)return r;switch(i=0,r&&(n=[2&n[0],r.value]),n[0]){case 0:case 1:r=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,i=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==n[0]&&2!==n[0])){s=0;continue}if(3===n[0]&&(!r||n[1]>r[0]&&n[1]<r[3])){s.label=n[1];break}if(6===n[0]&&s.label<r[1]){s.label=r[1],r=n;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(n);break}r[2]&&s.ops.pop(),s.trys.pop();continue}n=e.call(t,s)}catch(t){n=[6,t],i=0}finally{o=r=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,a])}}}function s(t){var e="function"==typeof Symbol&&Symbol.iterator,o=e&&t[e],i=0;if(o)return o.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function a(t,e){var o="function"==typeof Symbol&&t[Symbol.iterator];if(!o)return t;var i,r,n=o.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=n.next()).done;)s.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(o=n.return)&&o.call(n)}finally{if(r)throw r.error}}return s}function h(t,e,o){if(o||2===arguments.length)for(var i,r=0,n=e.length;r<n;r++)!i&&r in e||(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return t.concat(i||Array.prototype.slice.call(e))}var c,l,d={SDK_VERSION:"1.1.1",GATEWAY_ADDRESS:"https://wbgw.agrtc.cn",GATEWAY_ADDRESS1:"https://wbgw.agrtc.cn",GATEWAY_ADDRESS_SSL:!0,GATEWAY_CONNECT_TIMEOUT:2e3,REPORT_DOMAIN:"",REPORT_BACKUP_DOMAIN:"",LOADING_ICON:"data:image/svg+xml,%3c%3fxml version='1.0' encoding='UTF-8'%3f%3e%3csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' style='margin: auto%3b display: block%3b' width='140px' height='140px' viewBox='0 0 100 100' preserveAspectRatio='xMidYMid'%3e %3cdefs%3e %3cfilter id='filter' x='-100%25' y='-100%25' width='300%25' height='300%25' color-interpolation-filters='sRGB'%3e %3cfeGaussianBlur in='SourceGraphic' stdDeviation='2.4000000000000004'%3e%3c/feGaussianBlur%3e %3cfeComponentTransfer result='cutoff'%3e %3cfeFuncA type='table' tableValues='0 0 0 0 0 0 1 1 1 1 1'%3e%3c/feFuncA%3e %3c/feComponentTransfer%3e %3c/filter%3e %3c/defs%3e %3cg filter='url(%23filter)'%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23220b09'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='4s' repeatCount='indefinite' begin='-0.25s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='4s' repeatCount='indefinite' begin='0s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23d34c31'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='2s' repeatCount='indefinite' begin='-0.20833333333333334s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='2s' repeatCount='indefinite' begin='-0.041666666666666664s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23e88432'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='1.3333333333333333s' repeatCount='indefinite' begin='-0.16666666666666666s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='1.3333333333333333s' repeatCount='indefinite' begin='-0.08333333333333333s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23ff312d'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='1s' repeatCount='indefinite' begin='-0.125s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='1s' repeatCount='indefinite' begin='-0.125s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23f5c037'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='0.8s' repeatCount='indefinite' begin='-0.08333333333333333s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='0.8s' repeatCount='indefinite' begin='-0.16666666666666666s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3cg transform='translate(50 50)'%3e %3cg%3e %3ccircle cx='17' cy='0' r='5' fill='%23e89788'%3e %3canimate attributeName='r' keyTimes='0%3b0.5%3b1' values='3.5999999999999996%3b8.399999999999999%3b3.5999999999999996' dur='0.6666666666666666s' repeatCount='indefinite' begin='-0.041666666666666664s'%3e%3c/animate%3e %3c/circle%3e %3canimateTransform attributeName='transform' type='rotate' keyTimes='0%3b1' values='0%3b360' dur='0.6666666666666666s' repeatCount='indefinite' begin='-0.20833333333333334s'%3e%3c/animateTransform%3e %3c/g%3e %3c/g%3e%3c/g%3e%3c/svg%3e",BOARD_IMAGE_RESOURCE_TIMEOUT:3e4,BOARD_BACKGROUND_COLOR:"#FFFFFF",BOARD_SELECT_STYLE:{lineDash:[5,5],lineWidth:1,strokeStyle:"#ababab"},SHAPE_SELECT_STYLE:{lineDash:[8,8],strokeStyle:"#ababab",lineWidth:1},TEXT_INPUT_ELEMENT_OPTIONS:{kind:"textarea",props:{"has-origin-text":"0",spellCheck:!1},style:{":focus-border":"1px solid red","z-index":"9",position:"absolute",display:"inline-block","backface-visibility":"hidden",margin:"0px",padding:"0px",outline:"none",resize:"none",background:"transparent",overflow:"hidden","white-space":"pre-wrap","word-break":"break-all","font-family":"customFontFamily , sans-serif, serif, monospace","font-style":"normal","font-weight":"normal",top:"0px",left:"0px","min-width":"12px","min-height":"12px",width:"12px",height:"12px",border:"1px solid transparent","box-sizing":"content-box",color:"#333333","font-size":"12px","line-height":"12px"}},CONTROL_DIR_STYLE:{position:"absolute",width:"8px",height:"8px",background:"red","background-clip":"padding-box",border:"2px solid transparent","box-sizing":"content-box"}};t.EBoardErrorCode=void 0,(c=t.EBoardErrorCode||(t.EBoardErrorCode={}))[c.INVALID_PARAMS=1e3]="INVALID_PARAMS",c[c.INVALID_OPERATION=1001]="INVALID_OPERATION",c[c.INIT_ERROR=2e3]="INIT_ERROR",c[c.AUTH_FAILED=2001]="AUTH_FAILED",c[c.AUTH_TIMEOUT=2002]="AUTH_TIMEOUT",c[c.HISTORY_SYNC_FAILED=2003]="HISTORY_SYNC_FAILED",function(t){t[t.INVALID_IMAGE_ASSETS=3e3]="INVALID_IMAGE_ASSETS",t[t.TIME_OUT=3001]="TIME_OUT"}(l||(l={}));var p,u,_,f,v,E,g="NETWORK_TIMEOUT",y="NETWORK_RESPONSE_ERROR",S="NETWORK_ERROR",T="MISSING_PARAMETER",A="DEVELOPER_INVALID",m="UID_BANNED",b="IP_BANNED",C="CHANNEL_BANNED",I="APPID_INVALID",D="SERVER_NOT_OPEN",B="TOKEN_EXPIRED",w="TOKEN_INVALID",O="CAN_NOT_GET_GATEWAY_SERVER",R="GATEWAY_SERVER_ERROR";t.EBoardTextStyle=void 0,(p=t.EBoardTextStyle||(t.EBoardTextStyle={}))[p.NORMAL=0]="NORMAL",p[p.BOLD=1]="BOLD",p[p.ITALIC=2]="ITALIC",p[p.BOLD_ITALIC=3]="BOLD_ITALIC",function(t){t.ARROW="Arrow",t.CIRCLE="Circle",t.LASER_POINTER="LaserPointer",t.ELLIPSE="Ellipse",t.RECT="Rect",t.LINE="Line",t.FREE_DRAW="FreeDraw",t.TEXT="Text"}(u||(u={})),function(t){t[t.CONNECT=2e5]="CONNECT",t[t.INIT=3e5]="INIT",t[t.CHAN_DATA=300001]="CHAN_DATA",t[t.ADD_FILE=300002]="ADD_FILE",t[t.DELETE_FILE=300003]="DELETE_FILE",t[t.FILE_LIST=300004]="FILE_LIST",t[t.BRUSH_DATA=300005]="BRUSH_DATA",t[t.CUR_BOARD_DATA=300006]="CUR_BOARD_DATA",t[t.CACHE_BOARD_DATA=300007]="CACHE_BOARD_DATA",t[t.RE_UPLOAD=300008]="RE_UPLOAD",t[t.BOARD_LIST=31e4]="BOARD_LIST",t[t.CHAN_BOARD_LIST=310001]="CHAN_BOARD_LIST",t[t.BOARD_DATA=310002]="BOARD_DATA",t[t.ADD_BOARD=310003]="ADD_BOARD",t[t.SWITCH_BOARD=310004]="SWITCH_BOARD",t[t.DELETE_BOARD=310005]="DELETE_BOARD",t[t.SCALE_BOARD=310006]="SCALE_BOARD",t[t.BOARD_RATIO=310007]="BOARD_RATIO",t[t.RESET_BOARD=310008]="RESET_BOARD",t[t.CLEAR_BOARD=310009]="CLEAR_BOARD",t[t.UPDATE_BACKGROUND=310010]="UPDATE_BACKGROUND",t[t.UPDATE_BACKGROUND_IMAGE=310011]="UPDATE_BACKGROUND_IMAGE",t[t.UPDATE_BACKGROUND_H5=310012]="UPDATE_BACKGROUND_H5",t[t.ADD_SHAPE=32e4]="ADD_SHAPE",t[t.MOVE_SHAPE=320001]="MOVE_SHAPE",t[t.DELETE_SHAPE=320002]="DELETE_SHAPE",t[t.PROCESS_SHAPE=320003]="PROCESS_SHAPE",t[t.INVALID_PARAMS=4e5]="INVALID_PARAMS",t[t.INTERNAL_ERROR=5e5]="INTERNAL_ERROR",t[t.KEEP_A_LIVE=6e5]="KEEP_A_LIVE"}(_||(_={})),function(t){t.ERROR="board-error",t.WARNING="board-warning",t.CONNECTION_STATE_CHANGE="connection-state-change",t.DATA_SYNC_COMPLETED="data-sync-completed",t.ADD_BOARD="add-board",t.DELETE_BOARD="delete-board",t.GOTO_BOARD="goto-board",t.CLEAR_BOARD="clear-board",t.RESET_BOARD="reset-board",t.SCALE_BOARD="board-scale-change",t.RATIO_BOARD="board-ratio-change",t.CAN_UNDO_STATUS_CHANGE="board-can-undo-status",t.CAN_REDO_STATUS_CHANGE="board-can-redo-status",t.BOARD_BACKGROUND_COLOR_CHANGE="board-background-color-change",t.IMAGE_STATUS_CHANGED="board-image-status-changed"}(f||(f={})),t.EBoardToolType=void 0,(v=t.EBoardToolType||(t.EBoardToolType={}))[v.NONE=0]="NONE",v[v.SELECT=1]="SELECT",v[v.FREE_DRAW=2]="FREE_DRAW",v[v.ERASER=3]="ERASER",v[v.LASER_POINTER=4]="LASER_POINTER",v[v.LINE=5]="LINE",v[v.ARROW=6]="ARROW",v[v.RECT=7]="RECT",v[v.ELLIPSE=8]="ELLIPSE",v[v.TEXT=9]="TEXT",function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SELECTED=1]="SELECTED",t[t.FOCUSED=2]="FOCUSED"}(E||(E={}));var L,x=function(){function t(t,e,o,i,r){void 0===i&&(i=[0,0]),this.id="",this.rectWithStrokePadding=10,this._props={},this._position=[0,0],this._rect={x:0,y:0,width:0,height:0},this._rectWithStroke={x:0,y:0,width:0,height:0},this.style={lineWidth:1,opacity:1,lineDash:[],fillStyle:"",strokeStyle:"#000000"},this.selectState=E.DEFAULT,this.group=0,this.id=t,this.type=e,r&&(this.style=r),this.props=o,this.position=i}return Object.defineProperty(t.prototype,"props",{get:function(){return this._props},set:function(t){this._props=t,this._rect=this._calculateShapeRectBounding(),this._rectWithStroke=this._calculateShapeRectWithStrokeBounding()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t,this._rect=this._calculateShapeRectBounding(),this._rectWithStroke=this._calculateShapeRectWithStrokeBounding()},enumerable:!1,configurable:!0}),t.prototype.getBoundingRect=function(){return this._rectWithStroke},t.prototype.rectContain=function(t,e){var o=this._rectWithStroke,i=o.x,r=o.y,n=o.width,s=o.height;return t>=i&&t<=i+n&&e>=r&&e<=r+s},t.prototype.isPointInPath=function(t,e){return!1},t.prototype.buildPath=function(t,e){var o=i(i({},this.style),null==e?void 0:e.style),r=o.strokeStyle,n=o.lineWidth,s=o.lineDash,a=o.fillStyle;a&&(t.fillStyle=a),r&&(t.strokeStyle=r),n&&(t.lineWidth=n),s&&t.setLineDash(s)},t.prototype.buildElement=function(t){},t.prototype.attr=function(t,e){"props"===t?this.props=i(i({},this.props),e):"position"===t?this.position=h([],a(e)):"style"===t&&(this.style=i(i({},this.style),e))},t.prototype._calculateShapeRectBounding=function(){return{x:0,y:0,width:0,height:0}},t.prototype._calculateShapeRectWithStrokeBounding=function(){return{x:0,y:0,width:0,height:0}},t}(),N=function(t){function e(e,o){return t.call(this,e,u.ARROW,o.props||{points:[]},o.position||[0,0],o.style||{fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"})||this}return o(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this._props.points,e=this.position;if(4===(null==t?void 0:t.length)){var o=this.style.lineWidth,i=o/2,r=0,n=0,s=0,a=0;t.forEach((function(t,o){0===o?(r=s=t[0]+e[0],n=a=t[1]+e[1]):(r=t[0]+e[0]<r?t[0]+e[0]:r,n=t[1]+e[1]<n?t[1]+e[1]:n,s=t[0]+e[0]>s?t[0]+e[0]:s,a=t[1]+e[1]>a?t[1]+e[1]:a)}));var h=Math.floor(Math.abs(s-r)),c=Math.floor(Math.abs(a-n));return{x:r-i,y:n-i,width:h+o,height:c+o}}return{x:0,y:0,width:0,height:0}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props.points,e=this.position;if(4===(null==t?void 0:t.length)){var o=this.style.lineWidth,i=o/2,r=0,n=0,s=0,a=0;t.forEach((function(t,o){0===o?(r=s=t[0]+e[0],n=a=t[1]+e[1]):(r=t[0]+e[0]<r?t[0]+e[0]:r,n=t[1]+e[1]<n?t[1]+e[1]:n,s=t[0]+e[0]>s?t[0]+e[0]:s,a=t[1]+e[1]>a?t[1]+e[1]:a)}));var h=Math.floor(Math.abs(s-r)),c=Math.floor(Math.abs(a-n));return{x:r-this.rectWithStrokePadding/2-i,y:n-this.rectWithStrokePadding/2-i,width:h+this.rectWithStrokePadding+o,height:c+this.rectWithStrokePadding+o}}return{x:0,y:0,width:0,height:0}},e.prototype.isPointInPath=function(t,e){var o=this._props.points,i=this.position;if(4===(null==o?void 0:o.length)){var r=this.style.lineWidth/2,n=0,s=0,a=0,h=0;return o.forEach((function(t,e){0===e?(n=a=t[0]+i[0],s=h=t[1]+i[1]):(n=(t[0]+i[0]<n?t[0]+i[0]:n)-r,s=(t[1]+i[1]<s?t[1]+i[1]:s)-r,a=(t[0]+i[0]>a?t[0]+i[0]:a)+r,h=(t[1]+i[1]>h?t[1]+i[1]:h)+r)})),t>=n&&t<=a&&e>=s&&e<=h}return!1},e.prototype.buildPath=function(e,o){e.save(),t.prototype.buildPath.call(this,e,o);var r=i(i({},this.props),null==o?void 0:o.props),n=(null==o?void 0:o.position)||this.position;if(r&&r.points&&r.points.length>=4){var s=r.points;e.beginPath(),e.moveTo(s[0][0]+n[0],s[0][1]+n[1]),e.lineTo(s[1][0]+n[0],s[1][1]+n[1]),e.moveTo(s[2][0]+n[0],s[2][1]+n[1]),e.lineTo(s[1][0]+n[0],s[1][1]+n[1]),e.lineTo(s[3][0]+n[0],s[3][1]+n[1]),e.stroke()}e.restore()},e}(x),P=function(t){function e(e,o){return t.call(this,e,u.CIRCLE,o.props||{x1:0,y1:0,x2:0,y2:0},o.position||[0,0],o.style||{fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"})||this}return o(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.x1,o=t.x2,i=t.y1,r=t.y2,n=this.style.lineWidth,s=n/2;return{x:(e<o?e:o)-s,y:(i<r?i:r)-s,width:Math.abs(e-o)+n,height:Math.abs(i-r)+n}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.x1,o=t.x2,i=t.y1,r=t.y2,n=this.style.lineWidth,s=n/2,a=(i<r?i:r)-s;return{x:(e<o?e:o)-s-this.rectWithStrokePadding/2,y:a-this.rectWithStrokePadding/2,width:Math.abs(e-o)+this.rectWithStrokePadding+n,height:Math.abs(i-r)+this.rectWithStrokePadding+n}},e.prototype.isPointInPath=function(t,e){var o=this._props,i=o.x1,r=o.x2,n=o.y1,s=o.y2,a=this.style.lineWidth/2;return t>=(i<r?i:r)-a&&t<=(i<r?r:i)+a&&e>=(n<s?n:s)-a&&e<=(n<s?s:n)+a},e.prototype.buildPath=function(e,o){t.prototype.buildPath.call(this,e,o);var i=o.props,r=o.style;if(r&&r.fillStyle||this.style&&this.style.fillStyle,i){var n=i.x1,s=i.x2,a=i.y1,h=i.y2,c=0,l=0,d=0,p=0;n<s?(c=n,l=a,d=s,p=h):(c=s,l=h,d=n,p=a);var u=Math.abs(d-c),_=Math.abs(p-l),f=u<_?_/2:u/2,v=c+f,E=l+f;e.beginPath(),e.arc(v,E,f,0,360),e.stroke()}},e}(x),M=function(t){function e(e,o){return t.call(this,e,u.ELLIPSE,o.props||{cx:0,cy:0,xr:0,yr:0},o.position||[0,0],o.style||{fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"})||this}return o(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.cx,o=t.cy,i=t.xr,r=t.yr,n=this.position,s=this.style.lineWidth/2;return{x:Math.floor(e-i)+n[0]-s,y:Math.floor(o-r)+n[1]-s,width:2*i+s,height:2*r+s}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.cx,o=t.cy,i=t.xr,r=t.yr,n=this.position,s=this.style.lineWidth,a=s/2,h=Math.floor(e-i)+n[0]-a,c=Math.floor(o-r)+n[1]-a;return{x:h-this.rectWithStrokePadding/2,y:c-this.rectWithStrokePadding/2,width:2*i+this.rectWithStrokePadding+s,height:2*r+this.rectWithStrokePadding+s}},e.prototype.isPointInPath=function(t,e){var o=this._props,i=o.cx,r=o.cy,n=o.xr,s=o.yr,a=this.position,h=this.style.lineWidth/2,c=Math.floor(i-n)+a[0]-h,l=Math.floor(r-s)+a[1]-h,d=Math.floor(i+n)+a[0]+h,p=Math.floor(r+s)+a[1]+h;return t>=c&&t<=d&&e>=l&&e<=p},e.prototype.buildPath=function(e,o){e.save(),t.prototype.buildPath.call(this,e,o);var r=i(i({},this.props),null==o?void 0:o.props),n=(null==o?void 0:o.position)||this.position;if(r){var s=r.cx,a=r.cy,h=r.xr,c=r.yr;e.beginPath(),e.ellipse(s+n[0],a+n[1],h,c,0,0,360),e.stroke()}e.restore()},e}(x),k=function(t){function e(e,o){return t.call(this,e,u.FREE_DRAW,o.props||{points:[]},o.position||[0,0],o.style||{lineWidth:1,strokeStyle:"#000000"})||this}return o(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this.props.points,e=this.position;if(t&&t.length>1){var o=0,i=0,r=0,n=0;t.forEach((function(t,s){0===s?(o=r=t[0]+e[0],i=n=t[1]+e[1]):(o=t[0]+e[0]<o?t[0]+e[0]:o,i=t[1]+e[1]<i?t[1]+e[1]:i,r=t[0]+e[0]>r?t[0]+e[0]:r,n=t[1]+e[1]>n?t[1]+e[1]:n)}));var s=this.style.lineWidth,a=s/2,h=Math.floor(Math.abs(r-o))+s,c=Math.floor(Math.abs(n-i))+s;return{x:o-a,y:i-a,width:h,height:c}}return{x:0,y:0,width:0,height:0}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this.props.points,e=this.position;if(t&&t.length>1){var o=0,i=0,r=0,n=0;t.forEach((function(t,s){0===s?(o=r=t[0]+e[0],i=n=t[1]+e[1]):(o=t[0]+e[0]<o?t[0]+e[0]:o,i=t[1]+e[1]<i?t[1]+e[1]:i,r=t[0]+e[0]>r?t[0]+e[0]:r,n=t[1]+e[1]>n?t[1]+e[1]:n)}));var s=this.style.lineWidth,a=s/2,h=Math.floor(Math.abs(r-o))+s,c=Math.floor(Math.abs(n-i))+s;return{x:o-a-this.rectWithStrokePadding/2,y:i-a-this.rectWithStrokePadding/2,width:h+this.rectWithStrokePadding,height:c+this.rectWithStrokePadding}}return{x:0,y:0,width:0,height:0}},e.prototype.isPointInPath=function(t,e){var o=this.props.points,i=this.position;if(o&&o.length>1){var r=this.style.lineWidth/2,n=0,s=0,a=0,h=0;return o.forEach((function(t,e){0===e?(n=a=t[0]+i[0],s=h=t[1]+i[1]):(n=(t[0]+i[0]<n?t[0]+i[0]:n)-r,s=(t[1]+i[1]<s?t[1]+i[1]:s)-r,a=(t[0]+i[0]>a?t[0]+i[0]:a)+r,h=(t[1]+i[1]>h?t[1]+i[1]:h)+r)})),t>=n&&t<=a&&e>=s&&e<=h}return!1},e.prototype.buildPath=function(e,o){e.save(),t.prototype.buildPath.call(this,e,o);var r=i(i({},this.props),null==o?void 0:o.props),n=(null==o?void 0:o.position)||this.position;if(r){var s=r.points,a=n[0],h=n[1];if(!s)return;if(s.length>2){e.lineCap="round",e.lineJoin="round",e.beginPath();for(var c=0;c<s.length-1;c++)if(0===c)e.moveTo(s[0][0]+a,s[0][1]+h);else if(c===s.length-2)e.lineTo(s[c-1][0]+a,s[c-1][1]+h),e.stroke();else{if(c===s.length-1)return;var l=s[c+1],d=(l[0]+s[c+2][0])/2+a,p=(l[1]+s[c+2][1])/2+h;e.quadraticCurveTo(l[0]+a,l[1]+h,d,p)}}}e.restore()},e}(x),W=function(t,e){void 0===e&&(e={});var o=t.kind,r=t.key,n=t.props,s=t.style,a=t.children,h=document.createElement(o);return r&&(e[r]=h),n&&Object.keys(n).forEach((function(t){h.setAttribute(t,n[t])})),s&&Object.keys(s).forEach((function(t){h.style.setProperty(t,s[t])})),a&&a.forEach((function(t){var o=W(t,e);t.key&&(e[t.key]=o.el),h.append(o.el)})),i(i({},e),{el:h})},U=function(t){function e(e,o){var i=t.call(this,e,u.LASER_POINTER,o.props||{cx:0,cy:0,r:0},o.position||[0,0],o.style||{fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"})||this;i.touchId=0;var r=W({kind:"div",props:{"data-uid":e,class:"board-laser_item"},style:{position:"absolute",left:"0",top:"0",width:"32px",height:"32px","z-index":"40","will-change":"transform","pointer-events":"none",transform:"translate("+(i.props.cx+i.position[0]||0)+"px, "+(i.props.cy+i.position[1]||0)+"px) scale(1.0)"},children:[{kind:"img",props:{src:"data:image/svg+xml,%3c%3fxml version='1.0' encoding='UTF-8'%3f%3e%3csvg width='32px' height='32px' viewBox='0 0 32 32' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e %3ctitle%3elaser-pointer%3c/title%3e %3cdefs%3e %3cradialGradient cx='50%25' cy='50%25' fx='50%25' fy='50%25' r='50%25' id='radialGradient-1'%3e %3cstop stop-color='%23FF001C' offset='0%25'%3e%3c/stop%3e %3cstop stop-color='%23FF001C' stop-opacity='0' offset='100%25'%3e%3c/stop%3e %3c/radialGradient%3e %3c/defs%3e %3cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'%3e %3cg transform='translate(-2.000000%2c -2.000000)'%3e %3ccircle fill='url(%23radialGradient-1)' cx='18' cy='18' r='12'%3e%3c/circle%3e %3ccircle stroke='white' fill='%23FF001C' cx='18' cy='18' r='2.5'%3e%3c/circle%3e %3c/g%3e %3c/g%3e%3c/svg%3e"},style:{display:"block","pointer-events":"none",position:"absolute",transform:"translate(-50%, -50%)"}}]}).el;return i.el=r,i}return o(e,t),e.prototype._getTextBounding=function(){var t,e;return{width:(null===(t=this.el)||void 0===t?void 0:t.offsetWidth)||0,height:(null===(e=this.el)||void 0===e?void 0:e.offsetHeight)||0}},e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.x,o=t.y,i=this.position,r=this._getTextBounding(),n=r.width,s=r.height;return{x:e+i[0],y:o+i[1],width:n,height:s}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.x,o=t.y,i=this.position,r=this._getTextBounding(),n=r.width,s=r.height;return{x:e+i[0]-this.rectWithStrokePadding/2,y:o+i[1]-this.rectWithStrokePadding/2,width:n+this.rectWithStrokePadding,height:s+this.rectWithStrokePadding}},e.prototype.isPointInPath=function(t,e){var o=this._props,i=o.cx,r=o.cy,n=this.position,s=this._getTextBounding(),a=s.width,h=s.height,c=i+n[0],l=r+n[1];return t>=c&&t<=c+a&&e>=l&&e<=l+h},e.prototype.buildPath=function(t,e){},e.prototype.addPosition=function(t,e){this.position[0]+=t,this.position[1]+=e,this.setPosition(this.position[0],this.position[1])},e.prototype.setPosition=function(t,e){var o=this;this.el&&(this.position=[t,e],document.querySelectorAll(".board-laser_item").forEach((function(i){i.getAttribute("data-uid")===o.id&&(o.el=i,o.el.style.transform="translate("+(o.props.cx+t)+"px, "+(o.props.cy+e)+"px) scale(1.0)")})))},e.prototype.buildElement=function(t){var e;t instanceof HTMLElement?t.appendChild(this.el):"string"==typeof t&&(null===(e=document.querySelector("#"+t))||void 0===e||e.appendChild(this.el))},e.prototype.dispose=function(){var t;null===(t=this.el)||void 0===t||t.remove()},e}(x),G=function(t){function e(e,o){return t.call(this,e,u.LINE,o.props||{x:0,y:0,x1:0,y1:0},o.position||[0,0],o.style||{fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"})||this}return o(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.x,o=t.y,i=t.x1,r=t.y1,n=this.position,s=this.style.lineWidth,a=s/2,h=(o<r?o:r)-a;return{x:(e<i?e:i)-a+n[0],y:h+n[1],width:Math.floor(Math.abs(i-e))+s,height:Math.floor(Math.abs(r-o))+s}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.x,o=t.y,i=t.x1,r=t.y1,n=this.position,s=this.style.lineWidth,a=s/2,h=(o<r?o:r)-a;return{x:(e<i?e:i)-a+n[0]-this.rectWithStrokePadding/2,y:h+n[1]-this.rectWithStrokePadding/2,width:Math.floor(Math.abs(i-e))+this.rectWithStrokePadding+s,height:Math.floor(Math.abs(r-o))+this.rectWithStrokePadding+s}},e.prototype.isPointInPath=function(t,e){var o=this._props,i=o.x,r=o.y,n=o.x1,s=o.y1,a=this.position,h=this.style.lineWidth/2,c=(i<n?i:n)+a[0]-h,l=(r<s?r:s)+a[1]-h,d=(i<n?n:i)+a[0]+h,p=(r<s?s:r)+a[1]+h;return t>=c&&t<=d&&e>=l&&e<=p},e.prototype.buildPath=function(e,o){e.save(),t.prototype.buildPath.call(this,e,o);var r=i(i({},this.props),null==o?void 0:o.props),n=(null==o?void 0:o.position)||this.position;if(r){var s=r.x,a=r.y,h=r.x1,c=r.y1;e.beginPath(),e.moveTo(s+n[0],a+n[1]),e.lineTo(h+n[0],c+n[1]),e.stroke()}e.restore()},e}(x),H=function(t){function e(e,o){return t.call(this,e,u.RECT,i({x1:0,y1:0,x2:0,y2:0},o.props),o.position||[0,0],i({fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000"},o.style))||this}return o(e,t),e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.x1,o=t.y1,i=t.x2,r=t.y2,n=this.position,s=this.style.lineWidth,a=s/2,h=e<i?e:i-a,c=o<r?o:r-a,l=Math.abs(i-e)+s,d=Math.abs(r-o)+s;return{x:h+n[0],y:c+n[1],width:l+s,height:d+s}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.x1,o=t.y1,i=t.x2,r=t.y2,n=this.position,s=this.style.lineWidth,a=s/2,h=(e<i?e:i)-a,c=(o<r?o:r)-a,l=Math.abs(i-e)+s,d=Math.abs(r-o)+s;return{x:h+n[0]-this.rectWithStrokePadding/2,y:c+n[1]-this.rectWithStrokePadding/2,width:l+this.rectWithStrokePadding,height:d+this.rectWithStrokePadding}},e.prototype.isPointInPath=function(t,e){var o=this._props,i=o.x1,r=o.y1,n=o.x2,s=o.y2,a=this.position,h=this.style.lineWidth/2,c=(i<n?i:n)+a[0]-h,l=(r<s?r:s)+a[1]-h,d=(i<n?n:i)+a[0]+h,p=(r<s?s:r)+a[1]+h;return t>=c&&t<=d&&e>=l&&e<=p},e.prototype.buildPath=function(e,o){e.save(),t.prototype.buildPath.call(this,e,o);var r=i(i({},this.props),null==o?void 0:o.props),n=(null==o?void 0:o.position)||this.position;if(r){var s=r.x1,a=r.y1,h=r.x2,c=r.y2,l=(s<h?s:h)+n[0],d=(a<c?a:c)+n[1];e.beginPath(),e.rect(l,d,Math.abs(h-s),Math.abs(c-a)),e.stroke()}e.restore()},e}(x),F=document.createElement("canvas").getContext("2d"),V=function(t,e,o){var i=t.replace(/\n|\r/gi,"<br />").split("<br />"),r=[],n=0;return i.forEach((function(t,i){var s=K(t,e,o),c=s.width,l=s.list;n<c&&(n=c),r.push.apply(r,h([],a(l)))})),{width:n,height:r.length*e.lineHeight,list:r}},K=function(t,e,o){var i=0,r=[],n=e.fontStyle,s=e.fontWeight,a=e.fontSize,h=e.fontFamily,c=e.lineHeight;if(F.font=n+" "+s+" "+a+"px/"+c+"px "+h,F.measureText(t).width<=o){var l=Math.ceil(F.measureText(t).width);r.push({text:t,width:l}),i=l>a?l:a}else for(var d="",p=0,u=0;u<t.length;u++){d+=t[u];var _=F.measureText(d).width;if(_===o){l=Math.ceil(F.measureText(t.substring(p,u+1)).width);r.push({text:t.substring(p,u+1),width:l}),i<l&&(i=l),p=u+1,d=""}else if(_>o){l=Math.ceil(F.measureText(t.substring(p,u)).width);r.push({text:t.substring(p,u),width:l}),i<l&&(i=l),p=u;var f=t.substring(p),v=Math.ceil(F.measureText(f).width);if(v<=o){r.push({text:f,width:v}),i<v&&(i=v);break}d=t[u]}else if(u===t.length-1){l=Math.ceil(F.measureText(t.substring(p)).width);r.push({text:t.substring(p),width:l}),i<l&&(i=l)}}return{list:r,width:i}},q=function(t){function e(e,o){return t.call(this,e,u.TEXT,i({text:"",x:0,y:0,width:0,height:0,maxWidth:0,maxHeight:0,fontSize:12,lineHeight:12},o.props),o.position||[0,0],i({fillStyle:"transparent",lineWidth:1,strokeStyle:"#000000",textFill:"#000000",textStroke:"#000000",fontFamily:"customFontFamily, sans-serif, serif, monospace"},o.style))||this}return o(e,t),e.prototype._getTextBounding=function(){var t=W({kind:"canvas"}).el.getContext("2d"),e=this._props,o=e.text,i=e.fontSize,r=e.lineHeight,n=this.style;n.lineWidth;var s=n.textStyle,a=n.textWeight,h=n.textFill,c=n.textStroke,l=n.fontFamily;if(c&&(t.strokeStyle=c),h&&(t.fillStyle=h),i&&(t.font=s+" "+a+" "+i+"px "+l),o){var d=V(o,{fontSize:i,lineHeight:r,fontFamily:l},this.props.maxWidth),p=d.width,u=d.height;return d.list,{width:p,height:u}}return{width:0,height:i||0}},e.prototype._calculateShapeRectBounding=function(){var t=this._props,e=t.x,o=t.y,i=this.position,r=this._getTextBounding(),n=r.width,s=r.height;return{x:e+i[0],y:o+i[1],width:n,height:s}},e.prototype._calculateShapeRectWithStrokeBounding=function(){var t=this._props,e=t.x,o=t.y,i=this.position,r=this._getTextBounding(),n=r.width,s=r.height;return{x:e+i[0]-this.rectWithStrokePadding/2,y:o+i[1]-this.rectWithStrokePadding/2,width:n+this.rectWithStrokePadding,height:s+this.rectWithStrokePadding}},e.prototype.isPointInPath=function(t,e){var o=this._props,i=o.x,r=o.y,n=this.position,s=this._getTextBounding(),a=s.width,h=s.height,c=i+n[0],l=r+n[1];return t>=c&&t<=c+a&&e>=l&&e<=l+h},e.prototype.setFontSize=function(t){this.style.fontSize=t,this._calculateShapeRectBounding(),this._calculateShapeRectWithStrokeBounding()},e.prototype.buildPath=function(e,o){t.prototype.buildPath.call(this,e,o);var r=i(i({},this.props),null==o?void 0:o.props);if((null==o?void 0:o.position)||this.position,r&&r.text){e.save();var n=r.text,s=r.fontSize,a=r.lineHeight,h=r.maxWidth,c=this._rect,l=c.x,d=c.y,p=c.width,u=c.height,_=i(i({},this.style),null==o?void 0:o.style),f=_.textStyle,v=_.textWeight,E=_.textFill,g=_.textStroke,y=_.fontFamily;g&&(e.fillStyle=g),E&&(e.fillStyle=E),s&&(e.font=f+" "+v+" "+s+"px "+y),e.beginPath(),e.rect(l,d,p,u);var S=V(n,{fontSize:s,lineHeight:a,fontStyle:f,fontWeight:v,fontFamily:y},h);S.width,S.height,S.list.forEach((function(t,o){e.fillText(t.text,l,d+(o+1)*a)})),e.restore()}},e}(x),z=function(t,e){var o="YYYY-MM-DD hh:mm:ss";if("number"!=typeof t)throw new Error("[timesToDate]: timestamp must be number");e&&"string"==typeof e&&(o=e);var i=t||Date.now(),r=new Date(i)||new Date(i),n=r.getFullYear(),s=r.getMonth()+1,a=r.getDate(),h=r.getHours(),c=r.getMinutes(),l=r.getSeconds(),d=r.getMilliseconds();return o.indexOf("YYYY")>-1&&(o=o.replace("YYYY",(function(t){return""+n}))),o.indexOf("MM")>-1?o=o.replace("MM",(function(t){return s<10?"0"+s:""+s})):o.indexOf("M")>-1&&(o=o.replace("M",(function(t){return""+s}))),o.indexOf("DD")>-1?o=o.replace("DD",(function(t){return a<10?"0"+a:""+a})):o.indexOf("D")>-1&&(o=o.replace("D",(function(t){return""+a}))),o.indexOf("hh")>-1?o=o.replace("hh",(function(t){return h<10?"0"+h:""+h})):o.indexOf("h")>-1&&(o=o.replace("h",(function(t){return""+h}))),o.indexOf("mm")>-1?o=o.replace("mm",(function(t){return c<10?"0"+c:""+c})):o.indexOf("m")>-1&&(o=o.replace("m",(function(t){return""+c}))),o.indexOf("ss")>-1?o=o.replace("ss",(function(t){return l<10?"0"+l:""+l})):o.indexOf("s")>-1&&(o=o.replace("s",(function(t){return""+l}))),o.indexOf("ms")>-1&&(o=o.replace("ms",(function(){return""+d}))),o.indexOf("AP")>-1&&(o=o.replace("AP",(function(){return h>12?"PM":"AM"}))),o},j=function(t,e){return Math.round(Number(t+"e"+e))/Math.pow(10,e)},Y=function(t,e){var o=a(t,4),i=o[0],r=o[1],n=o[2],s=o[3],h=e||30,c=180*Math.atan2(r-s,i-n)/Math.PI,l=(c+30)*Math.PI/180,d=(c-30)*Math.PI/180;return[[i,r],[n,s],[n+h*Math.cos(l),s+h*Math.sin(l)],[n+h*Math.cos(d),s+h*Math.sin(d)]]},J=function(t){void 0===t&&(t=13),t>20&&(t=20);var e=Math.ceil(Math.random()*Math.pow(10,t));return e<Math.pow(10,t-1)?J(t):e};!function(t){t[t.DEBUG=0]="DEBUG",t[t.INFO=1]="INFO",t[t.WARNING=2]="WARNING",t[t.ERROR=3]="ERROR",t[t.NONE=4]="NONE"}(L||(L={}));var X=function(){function t(){this.logPrefix="SupLogger",this.logLevel=L.NONE,this.uploadServeTranslators=[],this.DEBUG=L.DEBUG,this.INFO=L.INFO,this.WARNING=L.WARNING,this.ERROR=L.ERROR,this.NONE=L.NONE}return t.prototype.setLogLevel=function(t,e){e&&(this.logPrefix=e),"number"==typeof t&&t>-1&&t<5&&(this.logLevel=t)},t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!(this.logLevel>L.ERROR&&this.logLevel!==L.NONE||this.logLevel===L.NONE)){var o=t,i=Date.now();o.unshift("["+z(i,"hh:mm:ss:ms")+"] %c"+this.logPrefix+" [ERROR]:%c","color: #b00020; font-weight: bold;","color: #dc3545;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(t){t({type:"error",params:o,timestamp:i},(function(){console.error.apply(console,o)}))})):console.error.apply(console,o)}},t.prototype.warning=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!(this.logLevel>L.WARNING&&this.logLevel!==L.NONE||this.logLevel===L.NONE)){var o=t,i=Date.now();o.unshift("["+z(i,"hh:mm:ss:ms")+"] %c"+this.logPrefix+" [WARNING]:","color: #ffc107; font-weight: bold;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(t){t({type:"warning",params:o,timestamp:i},(function(){console.warn.apply(console,o)}))})):console.warn.apply(console,o)}},t.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!(this.logLevel>L.INFO&&this.logLevel!==L.NONE||this.logLevel===L.NONE)){var o=t,i=Date.now();o.unshift("["+z(i,"hh:mm:ss:ms")+"] %c"+this.logPrefix+" [INFO]:","color:  #007bff; font-weight: bold;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(t){t({type:"info",params:o,timestamp:i},(function(){console.log.apply(console,o)}))})):console.log.apply(console,o)}},t.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!(this.logLevel>L.DEBUG&&this.logLevel!==L.NONE||this.logLevel===L.NONE)){var o=t,i=Date.now();o.unshift("["+z(i,"hh:mm:ss.ms")+"] %c"+this.logPrefix+" [DEBUG]:","color:#6facff;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(t){t({type:"debug",params:o,timestamp:i},(function(){console.log.apply(console,o)}))})):console.log.apply(console,o)}},t}(),Q=new X;Q.setLogLevel(Q.DEBUG,"ar-whiteboard");var $,Z=Array.prototype,tt=function(){function t(){this._events={},this.addListener=this.on}return t.prototype.getListeners=function(t){return this._events[t]?Z.map.call(this._events[t],(function(t){return t.listener})):[]},t.prototype.on=function(t,e){this._events[t]||(this._events[t]=[]);var o=this._events[t];-1===this._indexOfListener(o,e)&&o.push({listener:e,once:!1})},t.prototype.once=function(t,e){this._events[t]||(this._events[t]=[]);var o=this._events[t];-1===this._indexOfListener(o,e)&&o.push({listener:e,once:!0})},t.prototype.off=function(t,e){this._events[t]||(this._events[t]=[]);var o=this._events[t],i=this._indexOfListener(o,e);-1!==i&&Z.splice.call(o,i,1)},t.prototype.removeAllListeners=function(t){t?delete this._events[t]:this._events={}},t.prototype.emit=function(t){for(var e,o,i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];this._events[t]||(this._events[t]=[]);var n=this._events[t];try{for(var a=s(n),h=a.next();!h.done;h=a.next()){var c=h.value;c.once&&this.off(t,c.listener),c.listener.apply(this,i||[])}}catch(t){e={error:t}}finally{try{h&&!h.done&&(o=a.return)&&o.call(a)}finally{if(e)throw e.error}}},t.prototype._indexOfListener=function(t,e){for(var o=t.length;o--;)if(t[o].listener===e)return o;return-1},t}(),et=function(){function t(t,e,o){void 0===e&&(e=""),this.name="ArWhiteBoardException",this.code=t;var i="ArWhiteBoardError".concat(" ").concat(this.code.toString(),": ");this.message=e?i.concat(e):i,this.data=o}return t.prototype.toString=function(){return this.data?"".concat(this.message," data: ").concat(JSON.stringify(this.data)):this.message},t}(),ot=function(){var t,e,o=navigator.userAgent;try{for(var i=s(["Android","iPhone","SymbianOS","Windows Phone","iPod","iPad"]),r=i.next();!r.done;r=i.next()){var n=r.value;if(o.indexOf(n)>=0)return!0}}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}return!1},it=function(e){function r(o,r){var n,s=e.call(this)||this;if(s.options={width:1920,height:1080,globalBackgroundColor:"#ffffff",backgroundColor:"",backgroundImage:"",backgroundImageFillMode:"contain",backgroundH5:"",progressBarUrl:"",ratio:"16:9",scale:100},s._boxWidth=0,s._boxHeight=0,s._width=0,s._height=0,s._controlBoxPosition=[0,0,0,0],s.selectStartPosition=[],s.selectLatestMovePosition=[],s._handleMouseDown=function(){},s._handleMouseMove=function(){},s._handleMouseUp=function(){},s._handleControlBoxMouseDown=function(){},s._handleControlBoxMouseMove=function(){},s._handleControlBoxMouseUp=function(){},o instanceof HTMLElement)n=o;else{if("string"!=typeof o||!document.querySelector("#"+o))throw new et(t.EBoardErrorCode.INVALID_PARAMS,"selector must be HTMLElement or Element id");n=document.querySelector("#"+o)}return s._rootDom=n,s.options=i(i(i({},s.options),r),{width:s._rootDom.clientWidth,height:s._rootDom.clientHeight}),s._calculateCanvasWidthAndHeight(),s.init(),s}return o(r,e),Object.defineProperty(r.prototype,"width",{get:function(){return this._width},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"height",{get:function(){return this._height},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"boxWidth",{get:function(){return this._boxWidth},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"boxHeight",{get:function(){return this._boxHeight},enumerable:!1,configurable:!0}),r.prototype.getRetinaScaling=function(){return window.devicePixelRatio||window.webkitDevicePixelRatio||window.mozDevicePixelRatio||1},r.prototype.init=function(){var t=W({key:"canvasBox",kind:"div",props:{class:"board_wrap"},style:{position:"relative",width:this._boxWidth+"px",height:this._boxHeight+"px",top:this._rootDom.offsetHeight/2+"px",left:this._rootDom.offsetWidth/2+"px",transform:"translate(-50%, -50%)",padding:"0px",margin:"0px","border-width":"0px",overflow:"hidden"},children:[{key:"cacheCanvas",kind:"canvas",props:{class:"board-cache_canvas",width:this._width,height:this._height},children:[]},{key:"canvas",kind:"canvas",props:{class:"board_canvas",width:this._width,height:this._height},children:[]},{key:"canvasBackgroundImage",kind:"img",props:{class:"board_background_image",src:""},children:[]},{key:"canvasBackground",kind:"div",props:{class:"board_background_wrap",width:"100%",height:"100%"},children:[]},{key:"cursorWrap",kind:"div",props:{class:"cursor_wrap_view",width:"100%",height:"100%"},children:[]},{key:"controlWrap",kind:"div",props:{class:"control_wrap_view",width:"100%",height:"100%"},children:[{key:"controlBox",kind:"div",children:[]}]},{key:"loading",kind:"img",props:{class:"board_loading",src:this.options.progressBarUrl},children:[]},{key:"textBox",kind:"div",props:{class:"board_text_box",width:"100%",height:"100%"},children:[{key:"textInput",kind:"textarea",props:i({class:"board-text_input"},d.TEXT_INPUT_ELEMENT_OPTIONS.props)}]},{key:"canvasH5",kind:"iframe",props:{class:"board_webview",width:"100%",height:"100%",src:""},children:[]}]}),e=t.el,o=t.canvasBox,r=t.canvas,n=t.cacheCanvas,s=t.canvasBackground,a=t.canvasBackgroundImage,h=t.canvasH5,c=t.textBox;t.textInput;var l=t.cursorWrap,p=t.loading,u=t.controlWrap,_=t.controlBox;this._rootDom.appendChild(e),this._canvasBox=o,this._canvas=r,this._cacheCanvas=n,this._canvasBgWrap=s,this._canvasBgImg=a,this._canvasBgH5=h,this._cursorWrap=l,this._loading=p,this._textBox=c,this._controlWrap=u,this._controlBox=_,this._canvasCtx=r.getContext("2d"),this._cacheCanvasCtx=n.getContext("2d"),this._handleControlBoxMouseDown=this.handleControlBoxMouseDown.bind(this),this._handleControlBoxMouseMove=this.handleControlBoxMouseMove.bind(this),this._handleControlBoxMouseUp=this.handleControlBoxMouseUp.bind(this),this._controlWrap.ontouchstart=this._controlWrap.onmousedown=this._handleControlBoxMouseDown,this._controlWrap.ontouchmove=this._controlWrap.onmousemove=this._handleControlBoxMouseMove,this._controlWrap.ontouchend=this._controlWrap.onmouseup=this._controlWrap.onmouseout=this._handleControlBoxMouseUp,this._canvas.oncontextmenu=function(t){t.preventDefault(),t.stopPropagation()},this.startHandleMoveEvent()},r.prototype.destroy=function(){this._rootDom.innerHTML=""},r.prototype.getSnapShortImage=function(){var t=W({kind:"canvas",props:{width:this.width,height:this.height},style:{}}).el,e=t.getContext("2d");return e.fillStyle=this.options.backgroundColor,e.fillRect(0,0,this.width,this.height),e.drawImage(this._cacheCanvas,0,0),t.toDataURL("image/png")},r.prototype.appendChild=function(t){this._canvasBox.appendChild(t)},r.prototype.setCanvasBGColor=function(t){this.options.backgroundColor=t,this._canvasBgWrap.style.backgroundColor=t},r.prototype.setCanvasBGImage=function(t,e){void 0===e&&(e="contain"),t?(this.options.backgroundImage=t,this.options.backgroundImageFillMode=e,this._canvasBgImg.src=t,this._canvasBgImg.style.visibility="visible",this._canvasBgImg.classList.remove("contain","cover","fill"),["contain","cover","fill"].includes(e)&&this._canvasBgImg.classList.add(e)):(this.options.backgroundImage="",this.options.backgroundImageFillMode="contain",this._canvasBgImg.classList.remove("contain","cover","fill"),this._canvasBgImg.removeAttribute("src"),this._canvasBgImg.style.visibility="hidden")},r.prototype.setCanvasBGH5=function(t){t?(this.options.backgroundH5=t,this._canvasBgH5.src=t,this._canvasBgH5.style.visibility="visible"):(this.options.backgroundH5="",this._canvasBgH5.src="",this._canvasBgH5.style.visibility="hidden")},r.prototype.createTextInput=function(t){this._textBox.appendChild(t)},r.prototype.showControlWrap=function(){this._controlWrap.style.display="block",this._controlWrap.style.zIndex="100"},r.prototype.hideControlWrap=function(){this._controlWrap.style.display="block",this._controlWrap.style.zIndex="0"},r.prototype.setControlBoxSize=function(t){var e=t[0],o=t[1],i=t[2],r=t[3];this._controlBox.style.width=i-e+"px",this._controlBox.style.height=r-o+"px",this.setControlBoxPosition(t)},r.prototype.setControlBoxPosition=function(t){var e=(this.boxWidth-this.width)/2,o=(this.boxHeight-this.height)/2,i=t[0]+e,r=t[1]+o;this._controlBoxPosition=t,this._controlBox.style.transform="translateX("+i+"px) translateY("+r+"px) rotate(0deg)"},r.prototype.showLoading=function(){this._loading.style.display="block"},r.prototype.hideLoading=function(){this._loading.style.display="none"},r.prototype.renderSize=function(){this._calculateCanvasWidthAndHeight(),this._canvasBox.style.width=this._boxWidth+"px",this._canvasBox.style.height=this._boxHeight+"px",this._canvasBox.style.top=this._rootDom.offsetHeight/2+"px",this._canvasBox.style.left=this._rootDom.offsetWidth/2+"px",this._canvas.width=this._cacheCanvas.width=this._width,this._canvas.height=this._cacheCanvas.height=this._height,this._canvas.style.width=this._cacheCanvas.style.width=this._width+"px",this._canvas.style.height=this._cacheCanvas.style.height=this._height+"px",this._boxWidth>this._width?(this._canvas.style.marginTop=this._cacheCanvas.style.marginTop=(this._boxHeight-this._height)/2+"px",this._canvas.style.marginLeft=this._cacheCanvas.style.marginLeft=(this._boxWidth-this._width)/2+"px"):(this._canvas.style.marginTop=this._cacheCanvas.style.marginTop="0px",this._canvas.style.marginLeft=this._cacheCanvas.style.marginLeft="0px")},r.prototype.startHandleMoveEvent=function(){this._handleMouseDown=this.handleMouseDown.bind(this),this._handleMouseMove=this.handleMouseMove.bind(this),this._handleMouseUp=this.handleMouseUp.bind(this),ot()?(this._canvas.addEventListener("touchstart",this._handleMouseDown,!1),this._canvas.addEventListener("touchmove",this._handleMouseMove,!1),this._canvas.addEventListener("touchend",this._handleMouseUp,!1),this._canvas.addEventListener("touchcancel",this._handleMouseUp,!1)):(this._canvas.addEventListener("mouseenter",this._handleMouseDown,!1),this._canvas.addEventListener("mousedown",this._handleMouseDown,!1),this._canvas.addEventListener("mousemove",this._handleMouseMove,!1),this._canvas.addEventListener("mouseup",this._handleMouseUp,!1),this._canvas.addEventListener("mouseout",this._handleMouseUp,!1))},r.prototype.stopHandleMoveEvent=function(){ot()?(this._canvas.removeEventListener("touchstart",this._handleMouseDown,!1),this._canvas.removeEventListener("touchmove",this._handleMouseMove,!1),this._canvas.removeEventListener("touchend",this._handleMouseUp,!1),this._canvas.removeEventListener("touchcancel",this._handleMouseUp,!1)):(this._canvas.removeEventListener("mousedown",this._handleMouseDown,!1),this._canvas.removeEventListener("mousemove",this._handleMouseMove,!1),this._canvas.removeEventListener("mouseup",this._handleMouseUp,!1),this._canvas.removeEventListener("mouseout",this._handleMouseUp,!1))},r.prototype._calculateCanvasWidthAndHeight=function(){var t=this.options,e=t.ratio,o=t.scale,i=e.split(":"),r=Number(i[0]),n=Number(i[1]),s=this._rootDom.offsetWidth,a=this._rootDom.offsetHeight,h=0;h=s*n/r<a?s:a*r/n,this._boxWidth=h*(o/100),this._boxHeight=this._boxWidth*n/r;var c=window.screen.width,l=0,d=0,p=this._boxWidth<c?this._boxWidth:c,u=p*n/r;l=p,d=u,u>a&&(l=a*r/n,d=a),this._width=l,this._height=d},r.prototype.handleMouseDown=function(t){},r.prototype.handleMouseMove=function(t){},r.prototype.handleMouseUp=function(t){},r.prototype.handleMouseOut=function(t){},r.prototype.handleControlBoxMouseDown=function(t){},r.prototype.handleControlBoxMouseMove=function(t){},r.prototype.handleControlBoxMouseUp=function(t){},r.prototype.handleControlBoxMouseOut=function(t){},r.basicWidth=1920,r.basicHeight=1080,r}(tt),rt={Arrow:N,Circle:P,Ellipse:M,FreeDraw:k,LaserPointer:U,Line:G,Rect:H,Text:q},nt=2e3,st=function(e){function r(o,i){var r=e.call(this,o,i)||this;if(r._id="",r.uid="",r._enabled=!0,r._toolType=t.EBoardToolType.NONE,r._brushColor="#000000",r._brushThin=5,r._textStyle="normal",r._textWeight="normal",r._textSize=16,r._textColor="#333333",r._selectBoxColor="#ababab",r._brushCursor="default",r._selectShapes=[],r._laserPointer=null,r._textInput=null,r._temporaryList=new Map,r._displayList=new Map,r._canRedoList=[],r._canUndoList=[],r._mouseDown=!1,r._startPosition=[0,0],r._endPosition=[0,0],r._latestMovePosition=[],r._currentShape=null,r._selectShape=null,r._needUpdateShapeData=null,i){var n=i.brushColor,s=i.brushThin;i.scale;var a=i.textStyle,h=i.textSize,c=i.textColor,l=i.selectBoxColor;if(n&&(r._brushColor=n),s&&(r._brushThin=s),a){var d="normal",p="normal";switch(a){case t.EBoardTextStyle.BOLD:p="bold";break;case t.EBoardTextStyle.ITALIC:d="italic";break;case t.EBoardTextStyle.BOLD_ITALIC:d="italic",p="bold"}r._textStyle=d,r._textWeight=p}h&&(r._textSize=h),c&&(r._textColor=c),l&&(r._selectBoxColor=l)}return r}return o(r,e),Object.defineProperty(r.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"canUndoList",{get:function(){return this._canUndoList},set:function(t){this._canUndoList=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"canRedoList",{get:function(){return this._canRedoList},set:function(t){this._canRedoList=t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"brushColor",{get:function(){return this._brushColor},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"brushType",{get:function(){return this._toolType},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"brushThin",{get:function(){return this._brushThin},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"backgroundColor",{get:function(){return this.options.backgroundColor},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"backgroundImage",{get:function(){return this.options.backgroundImage},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"backgroundImageFillMode",{get:function(){return this.options.backgroundImageFillMode},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"brushId",{get:function(){return this.uid+"_"+Date.now()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"selectPenId",{get:function(){return"selector_"+(nt+=1)},enumerable:!1,configurable:!0}),r.prototype.setEnable=function(t){"boolean"==typeof t?this._enabled!==t&&(this._enabled=t,Q.info("set board enable as "+t)):Q.info("set board enable failed")},r.prototype.getEnable=function(){return this._enabled},r.prototype.getNeedUpdateShapeData=function(){var t=this._needUpdateShapeData;return this._needUpdateShapeData=null,t},r.prototype.setBrushType=function(e){var o=this;if(e!==t.EBoardToolType.NONE&&e!==t.EBoardToolType.SELECT&&e!==t.EBoardToolType.FREE_DRAW&&e!==t.EBoardToolType.TEXT&&e!==t.EBoardToolType.RECT&&e!==t.EBoardToolType.LINE&&e!==t.EBoardToolType.ELLIPSE&&e!==t.EBoardToolType.ARROW&&e!==t.EBoardToolType.ERASER&&e!==t.EBoardToolType.LASER_POINTER)throw new et(t.EBoardErrorCode.INVALID_PARAMS);Q.info("set brush type as "+e),this._setBrushCursor(e),this._selectShapes.length>0&&(this._displayList.forEach((function(t,e){o._selectShapes.includes(e)&&o.drawToCachePainter(t)})),this._selectShapes=[],this.hideControlWrap(),this._renderTemporaryCanvas())},r.prototype.setBrushColor=function(e){if("string"!=typeof e)throw new et(t.EBoardErrorCode.INVALID_PARAMS);Q.info("set brush color as "+e),this._brushColor=e},r.prototype.setBrushThin=function(e){if(!("number"==typeof e&&e>=1&&e<=20))throw new et(t.EBoardErrorCode.INVALID_PARAMS);this._brushThin=e,Q.info("set brush thin as "+e)},r.prototype.setTextStyle=function(){},r.prototype.getTextStyle=function(){},r.prototype.setLineStyle=function(){},r.prototype.getLineStyle=function(){},r.prototype.setTextSize=function(t){this._textSize=t},r.prototype.getTextSize=function(){return this._textSize},r.prototype.setTextColor=function(t){this._textColor=t},r.prototype.getTextColor=function(){return this._textColor},r.prototype.setBoardRatio=function(t){this.options.ratio=t,this.renderSize()},r.prototype.getBoardRatio=function(){return this.options.ratio},r.prototype.setSelectBoxColor=function(t){this._selectBoxColor=t},r.prototype.scalePainter=function(t){this.options.scale=t,this.renderSize()},r.prototype.undo=function(){var t=this._canUndoList.pop();if(t){var e=t.type;t.shapes,this._canRedoList.push(t),this._selectShapes=[],this.renderControlBox();var o=t.shapes[0],i=new rt[o.type](o.id,{props:o._props,position:o.position,style:o.style}),r=void 0;if(e===_.ADD_SHAPE){var n={pIds:[i.id]};r={bId:this.id,action:_.DELETE_SHAPE,data:n},this.removeElement(i.id)}else if(e===_.DELETE_SHAPE){var s={pId:i.id,shape:i.type,props:i.props,position:i.position,style:i.style,width:this.width,height:this.height,lts:Date.now()};r={bId:this.id,action:_.ADD_SHAPE,data:s},this.addElement(i)}else if(e===_.MOVE_SHAPE){var h=t.offset,c=t.shapes,l=a(h,2),d=l[0],p=l[1];this.moveElement(c.map((function(t){return t.id})),[-1*d*this.width,-1*p*this.height]);var u={pIds:c.map((function(t){return t.id})),offset:[-1*d,-1*p]};r={bId:this.id,action:_.MOVE_SHAPE,data:u}}this.emit("reportContent",r)}},r.prototype.redo=function(){var t=this._canRedoList.pop();if(t){this._canUndoList.push(t);var e=t.shapes[0],o=new rt[e.type](e.id,{props:e._props,position:e.position,style:e.style}),i=void 0;if(t.type===_.ADD_SHAPE){var r={pId:o.id,shape:o.type,props:o.props,position:o.position,style:o.style,width:this.width,height:this.height,lts:Date.now()};i={bId:this.id,action:_.ADD_SHAPE,data:r},this.addElement(o)}else if(t.type===_.DELETE_SHAPE){var n={pIds:[o.id]};i={bId:this.id,action:_.DELETE_SHAPE,data:n},this.removeElement(o.id)}else if(t.type===_.MOVE_SHAPE){var s=t.offset,h=t.shapes,c=a(s,2),l=c[0],d=c[1];this.moveElement(h.map((function(t){return t.id})),[l*this.width,d*this.height]);var p={pIds:h.map((function(t){return t.id})),offset:[l,d]};i={bId:this.id,action:_.MOVE_SHAPE,data:p}}this.emit("reportContent",i)}},r.prototype.addElement=function(t){if(this._displayList.get(t.id))throw Error("can not add again");if(!this._temporaryList.get(t.id)){if(t instanceof U){var e=document.querySelectorAll(".board-laser_item"),o=!1;e.forEach((function(e){e.getAttribute("data-uid")===t.id&&(o=!0)})),!o&&t.buildElement(this._cursorWrap)}else this.drawToCachePainter(t);this._displayList.set(t.id,t)}},r.prototype.removeElement=function(t){var e=this,o=this._displayList.get(t);if(o){this._displayList.delete(t);var i=this._selectShapes.findIndex((function(e){return e===t}));~i&&this._selectShapes.splice(i,1),this.renderControlBox(),o instanceof U?document.querySelectorAll(".board-laser_item").forEach((function(e){e.getAttribute("data-uid")===t&&e.remove()})):(this.clearCachePainter(),this._displayList.forEach((function(t){e.drawToCachePainter(t)})))}},r.prototype.moveElement=function(t,e){var o=this,i=a(e,2),r=i[0],n=i[1];this.clearCachePainter(),this._displayList.forEach((function(e,i){t.includes(e.id)?(null==e?void 0:e.type)===u.LASER_POINTER?(null==e||e.attr("position",[r,n]),e.setPosition(r,n)):(null==e||e.attr("position",[e.position[0]+r,e.position[1]+n]),o.drawToCachePainter(e)):o.drawToCachePainter(e)}))},r.prototype.refreshElement=function(t){var e=this._displayList.get(t);e&&e.buildPath(this._canvasCtx,e)},r.prototype.findElement=function(t){return this._displayList.get(t)},r.prototype.renderControlBox=function(){var t=this;if(this._selectShapes.length>0){var e=[],o=[],i=[],r=[];this._selectShapes.forEach((function(n){var s=t._displayList.get(n),a=null==s?void 0:s.getBoundingRect();e.push(a.x),o.push(a.y),i.push(a.x+a.width),r.push(a.y+a.height)})),this._controlBoxPosition=[Math.min.apply(Math,h([],a(e))),Math.min.apply(Math,h([],a(o))),Math.max.apply(Math,h([],a(i))),Math.max.apply(Math,h([],a(r)))],this.setControlBoxSize(this._controlBoxPosition),this.showControlWrap()}else this.hideControlWrap()},r.prototype.clearCanvas=function(){this.clearPainter(),this.clearCachePainter(),this._displayList.clear()},r.prototype.clearAllLaserPointer=function(){this._cursorWrap.innerHTML=""},r.prototype.clearOtherLaserPointer=function(){var t=this;this._displayList.forEach((function(e){e instanceof U&&e.id!==t.uid&&document.querySelectorAll(".board-laser_item").forEach((function(t){t.getAttribute("data-uid")!==e.id&&t.remove()}))}))},r.prototype.clearSelfLaserPoint=function(){var t=this;this._displayList.forEach((function(e){e instanceof U&&e.id!==t.uid&&document.querySelectorAll(".board-laser_item").forEach((function(t){t.getAttribute("data-uid")===e.id&&t.remove()}))}))},r.prototype.clear=function(t){void 0===t&&(t=!1),this.clearPainter(),this.clearCachePainter(),this._displayList.clear(),t||(this._selectShapes=[],this.hideControlWrap())},r.prototype.reset=function(){this.clearPainter(),this.clearCachePainter(),this._displayList.clear(),this._temporaryList.clear(),this._canUndoList=[],this._canRedoList=[],this._selectShape&&(this._selectShape=null),this._currentShape&&(this._toolType===t.EBoardToolType.FREE_DRAW?this._currentShape.props.points.length>1?(this._canUndoList.push({type:_.ADD_SHAPE,shapes:[this._currentShape]}),this.emit("reportContent",this._needUpdateShapeData),this._needUpdateShapeData=null):this.removeElement(this._currentShape.id):(this._canUndoList.push({type:_.ADD_SHAPE,shapes:[this._currentShape]}),this.emit("reportContent",this._needUpdateShapeData),this._needUpdateShapeData=null),this._currentShape=null)},r.prototype.clearAll=function(){this.clear(),this._canUndoList=[],this._canRedoList=[],this._cursorWrap.innerHTML=""},r.prototype.clearBackground=function(){this.setCanvasBGColor("#ffffff"),this.setCanvasBGImage("")},r.prototype._initCurrentShape=function(e,o){var r=this,n={};if(this._startPosition=[e,o],this._toolType===t.EBoardToolType.SELECT){var s=new H(this.selectPenId,{props:{x1:e,y1:o,x2:e,y2:o},style:i(i({},d.BOARD_SELECT_STYLE),{strokeStyle:this._selectBoxColor})});this._selectShape=this._createProxySetHandle(s,(function(t,e,o,i){if("props"===e||"position"===e||"style"===e){t[e]=o;var n=r._controlBoxPosition[0],s=r._controlBoxPosition[1],a=r._controlBoxPosition[2],h=r._controlBoxPosition[3];r._selectShapes=[];var c=t.getBoundingRect(),l=[c.x,c.y,c.x+c.width,c.y+c.height];r._displayList.forEach((function(t,e){var o,i,c,d,p,u,_,f,v,E,g=t.getBoundingRect(),y=[g.x,g.y,g.x+g.width,g.y+g.height];if(i=y,c=(o=l)[0],d=o[1],p=o[2],u=o[3],_=i[0],f=i[1],v=i[2],E=i[3],c<=_&&d<=f&&v<=p&&E<=u){var S=t.getBoundingRect();0===r._selectShapes.length&&(n=S.x,s=S.x+S.width,a=S.y,h=S.y+S.height),n=n<S.x?n:S.x,s=s<S.x+S.width?S.x+S.width:s,a=a<S.y?a:S.y,h=h<S.y+S.height?S.y+S.height:h,r._selectShapes.push(t.id)}})),r._controlBoxPosition=[n,a,s,h],r.clearPainter(),r._renderTemporaryCanvas(),r._drawToPainter(t)}}))}else if(this.brushType===t.EBoardToolType.FREE_DRAW){(l=[]).push(h([],a(this._startPosition))),n={points:l};var c=new k(this.brushId,{props:n,style:{lineWidth:this._brushThin,strokeStyle:this._brushColor}});this._currentShape=c}else if(this._toolType===t.EBoardToolType.ARROW){var l=h(h([],a(this._startPosition)),a(this._startPosition));n={points:Y(l,2.5*this._brushThin)};var p=new N(this.brushId,{props:n,style:{lineWidth:this._brushThin,strokeStyle:this._brushColor}});this._currentShape=p}else if(this._toolType===t.EBoardToolType.LINE){n={x:this._startPosition[0],y:this._startPosition[1],x1:this._startPosition[0],y1:this._startPosition[1]};var u=new G(this.brushId,{props:n,style:{lineWidth:this._brushThin,strokeStyle:this._brushColor}});this._currentShape=u}else if(this._toolType===t.EBoardToolType.RECT){n={x1:e,y1:o,x2:e,y2:o};var _=new H(this.brushId,{props:n,style:{lineWidth:this._brushThin,strokeStyle:this._brushColor}});this._currentShape=_}else if(this._toolType===t.EBoardToolType.ELLIPSE){n={cx:this._startPosition[0],cy:this._startPosition[1],xr:0,yr:0};var f=new M(this.brushId,{props:n,style:{lineWidth:this._brushThin,strokeStyle:this._brushColor}});this._currentShape=f}this._currentShape&&this._toolType!==t.EBoardToolType.SELECT&&this._temporaryList.set(this._currentShape.id,this._currentShape)},r.prototype.handleMouseDown=function(e){if(this._toolType!==t.EBoardToolType.NONE&&this._enabled){var o=0,i=0;if(e instanceof MouseEvent)o=e.offsetX,i=e.offsetY;else if(e.type.includes("touch")){var r=this._canvas.getBoundingClientRect();o=e.touches[0].clientX-r.left,i=e.touches[0].clientY-r.top}var n=j(Math.floor(o),1),s=j(Math.floor(i),1);if(this._toolType===t.EBoardToolType.LASER_POINTER){if(!this._laserPointer&&e.type.includes("touch")&&"touchstart"===e.type||e instanceof MouseEvent&&"mouseenter"===e.type){var a=new U(this.uid+"LaserPointer",{props:{cx:n,cy:s,r:10}});e.type.includes("touch")&&(a.touchId=e.touches[0].identifier),this._laserPointer=a,this._laserPointer.buildElement(this._cursorWrap);var h={pId:a.id,width:this.width,height:this.height,shape:a.type,props:a.props,style:a.style,position:a.position,lts:Date.now()},c={bId:this.id,action:_.ADD_SHAPE,data:h};this.emit("reportContent",c)}}else if(this._toolType===t.EBoardToolType.ERASER||this._toolType===t.EBoardToolType.TEXT)(e.type.includes("touch")&&"touchstart"===e.type||e instanceof MouseEvent&&"mousedown"===e.type&&0===e.button)&&(this._toolType===t.EBoardToolType.ERASER?this._eraserShape(n,s):this._toolType===t.EBoardToolType.TEXT&&(e.preventDefault(),e.stopPropagation(),this._textInput?(this._textInput.blur(),this._textInput=null):this._createTextInputAndHandleChange(n,s)));else if(this._toolType!==t.EBoardToolType.SELECT){if(e instanceof MouseEvent&&"mouseenter"===e.type)return;(e.type.includes("touch")&&"touchstart"===e.type||e instanceof MouseEvent&&"mousedown"===e.type&&e.buttons%2!=0)&&(this._startPosition=[n,s],!this._currentShape&&this._initCurrentShape(n,s))}}},r.prototype.handleMouseMove=function(e){var o,r,n,s,c,l,d,p,u,f,v,E,g,y;if(this._enabled&&this._toolType!==t.EBoardToolType.NONE){var S=0,T=0;if(e instanceof MouseEvent)S=e.offsetX,T=e.offsetY;else if(e.type.includes("touch")){var A=this._canvas.getBoundingClientRect();S=e.touches[0].clientX-A.left,T=e.touches[0].clientY-A.top}var m=j(Math.floor(S),1),b=j(Math.floor(T),1),C=[m,b];if(this._toolType===t.EBoardToolType.LASER_POINTER){if(this._laserPointer instanceof U&&(e.type.includes("touch")&&"touchmove"===e.type||e instanceof MouseEvent&&"mousemove"===e.type)){0===this._latestMovePosition.length&&(this._latestMovePosition=[m,b]);var I=m-this._latestMovePosition[0],D=b-this._latestMovePosition[1];this._latestMovePosition=[m,b],this._laserPointer.setPosition(this._laserPointer.position[0]+I,this._laserPointer.position[1]+D);var B={pIds:[this._laserPointer.id],offset:[this._laserPointer.position[0]/this.width,this._laserPointer.position[1]/this.height]},w={bId:this.id,action:_.MOVE_SHAPE,data:B};this._needUpdateShapeData=w}}else if(this._toolType===t.EBoardToolType.SELECT&&(e.type.includes("touch")&&"touchmove"===e.type||e instanceof MouseEvent&&"mousemove"===e.type&&e.buttons%2!=0))!this._selectShape&&this._initCurrentShape(m,b),this._selectShape.attr("props",{x2:C[0],y2:C[1]});else if(this._toolType!==t.EBoardToolType.ERASER&&this._toolType!==t.EBoardToolType.TEXT&&this._currentShape){var O=this._currentShape.style,R=O.strokeStyle;O.fillStyle;var L={};R&&(L.strokeStyle=this._brushColor),null===(o=this._currentShape)||void 0===o||o.attr("style",L);var x={pId:this._currentShape.id,shape:this._currentShape.type,style:this._currentShape.style,props:this._needUpdateShapeData?null===(n=null===(r=this._needUpdateShapeData)||void 0===r?void 0:r.data)||void 0===n?void 0:n.props:{},width:this.width,height:this.height,position:[0,0],lts:Date.now()};w={bId:this.id,action:_.ADD_SHAPE,data:x};if(this._toolType===t.EBoardToolType.FREE_DRAW){var N=(null===(s=this._currentShape)||void 0===s?void 0:s.props.points)||[],P=(null===(c=null==x?void 0:x.props)||void 0===c?void 0:c.points)||[];if(C[0]!==N[N.length-1][0]||C[1]!==N[N.length-1][1]){N.push(h([],a(C))),P.push([C[0],C[1]]);var M={points:N};null===(l=this._currentShape)||void 0===l||l.attr("props",M),this._renderTemporaryCanvas(),x.props={points:P},w.data=x,this._needUpdateShapeData=w}}else if(this._toolType===t.EBoardToolType.LINE){M=i(i({},null===(d=this._currentShape)||void 0===d?void 0:d.props),{x1:C[0],y1:C[1]});x.props=M,null===(p=this._currentShape)||void 0===p||p.attr("props",M),this._renderTemporaryCanvas(),w.data=x,this._needUpdateShapeData=w}else if(this._toolType===t.EBoardToolType.ARROW){N=h(h([],a(this._startPosition)),a(C));var k=Y(N,2.5*this._brushThin);M=i(i({},null===(u=this._currentShape)||void 0===u?void 0:u.props),{points:k});x.props=M,null===(f=this._currentShape)||void 0===f||f.attr("props",M),this._renderTemporaryCanvas(),w.data=x,this._needUpdateShapeData=w}else if(this._toolType===t.EBoardToolType.ELLIPSE){var W=function(t){var e=a(t,4),o=e[0],i=e[1],r=e[2],n=e[3],s=Math.abs(r-o)/2,h=Math.abs(n-i)/2;return[o<r?o+s:r+s,i<n?i+h:n+h,s,h]}(N=h(h([],a(this._startPosition)),a(C)));M=i(i({},null===(v=this._currentShape)||void 0===v?void 0:v.props),{cx:j(W[0],1),cy:j(W[1],1),xr:j(W[2],1),yr:j(W[3],1)});x.props=M,null===(E=this._currentShape)||void 0===E||E.attr("props",M),this._renderTemporaryCanvas(),w.data=x,this._needUpdateShapeData=w}else if(this._toolType===t.EBoardToolType.RECT){M=i(i({},null===(g=this._currentShape)||void 0===g?void 0:g.props),{x2:C[0],y2:C[1]});x.props=M,null===(y=this._currentShape)||void 0===y||y.attr("props",M),this._renderTemporaryCanvas(),w.data=x,this._needUpdateShapeData=w}}}},r.prototype.handleMouseUp=function(e){var o=this;if(this._enabled&&this._toolType!==t.EBoardToolType.NONE){var i=0,r=0;if(e instanceof MouseEvent)i=e.offsetX,r=e.offsetY;else if(e.type.includes("touch")){var n=this._canvas.getBoundingClientRect();i=e.changedTouches[0].clientX-n.left,r=e.changedTouches[0].clientY-n.top}var s=j(Math.floor(i),1),a=j(Math.floor(r),1);if(this._endPosition=[s,a],this._toolType!==t.EBoardToolType.LASER_POINTER)if(this._toolType===t.EBoardToolType.SELECT&&this._selectShape){if(Math.abs(this._endPosition[0]-this._startPosition[0])<=1&&Math.abs(this._endPosition[1]-this._startPosition[1])<=1){var h=[];if(this._displayList.forEach((function(t){t.type===u.TEXT?t.isPointInPath(i,r)&&(h=[t]):o._isPointInShape(i,r,t)&&(h=[t])})),h.length>0){this._selectShapes=[h[0].id];var c=h[0].getBoundingRect(),l=c.x,d=c.y,p=c.x+c.width,f=c.y+c.height;this.setControlBoxSize([l,d,p,f]),this.showControlWrap()}}else this.clearPainter(),this._selectShapes.length>0&&(this.showControlWrap(),this.setControlBoxSize(this._controlBoxPosition));this._selectShape=null}else this._toolType!==t.EBoardToolType.ERASER&&this._toolType!==t.EBoardToolType.TEXT&&(this._currentShape&&e instanceof MouseEvent&&"mouseup"===e.type&&0===e.button||e instanceof MouseEvent&&"mouseout"===e.type||e.type.includes("touch")&&"touchend"===e.type)&&(this._currentShape&&(this._toolType===t.EBoardToolType.FREE_DRAW?this._currentShape.props.points.length>1?(this._canUndoList.push({type:_.ADD_SHAPE,shapes:[this._currentShape]}),this.emit("reportContent",this._needUpdateShapeData),this._needUpdateShapeData=null):this.removeElement(this._currentShape.id):(this._canUndoList.push({type:_.ADD_SHAPE,shapes:[this._currentShape]}),this.emit("reportContent",this._needUpdateShapeData),this._needUpdateShapeData=null),this._displayList.set(this._currentShape.id,this._currentShape),this.drawToCachePainter(this._currentShape),this._temporaryList.delete(this._currentShape.id),this._renderTemporaryCanvas()),this._currentShape=null);else if(this._laserPointer&&e.type.includes("touch")&&("touchend"===e.type||"touchcancel"===e.type)||e instanceof MouseEvent&&"mouseout"===e.type){if(e.type.includes("touch")&&("touchend"===e.type||"touchcancel"===e.type)){var v=e,E=this._laserPointer.touchId,g=!1;for(var y in v.changedTouches){if(v.changedTouches[y].identifier===E){g=!0;break}}if(!g)return}this._needUpdateShapeData=null,this.emit("reportContent",{bId:this.id,action:_.DELETE_SHAPE,data:{pIds:[this._laserPointer.id]}}),this._laserPointer.dispose(),this._laserPointer=null,this._latestMovePosition=[]}}},r.prototype.handleControlBoxMouseDown=function(t){if(t.type.includes("touch")&&"touchstart"===t.type||t instanceof MouseEvent&&"mousedown"===t.type){var e=0,o=0;t instanceof MouseEvent?(e=t.pageX,o=t.pageY):t.type.includes("touch")&&(e=t.touches[0].pageX,o=t.touches[0].pageY),t.target===this._controlBox?(this.selectStartPosition.length<=0&&(this.selectStartPosition=[e,o],this.selectLatestMovePosition=[e,o]),t.stopPropagation(),t.preventDefault()):t.target===this._controlWrap&&this._selectShapes.length>0&&(this.hideControlWrap(),this._selectShapes=[])}},r.prototype.handleControlBoxMouseMove=function(t){var e=this,o=0,i=0;if(t instanceof MouseEvent?(o=t.pageX,i=t.pageY):t.type.includes("touch")&&(o=t.touches[0].pageX,i=t.touches[0].pageY),(t.type.includes("touch")&&"touchmove"===t.type||t instanceof MouseEvent&&"mousemove"===t.type&&t.buttons%2!=0)&&this.selectStartPosition.length>0){var r=o-this.selectLatestMovePosition[0],n=i-this.selectLatestMovePosition[1];e._controlBoxPosition[0]+=r,e._controlBoxPosition[1]+=n,e._controlBoxPosition[2]+=r,e._controlBoxPosition[3]+=n,e._controlBox.style.pointerEvents="none",e.setControlBoxPosition(e._controlBoxPosition),this.moveElement(e._selectShapes,[r,n]),this.selectLatestMovePosition=[o,i]}},r.prototype.handleControlBoxMouseUp=function(t){var e=this;if((t.type.includes("touch")||"mouseup"===t.type||t instanceof MouseEvent&&"mouseout"===t.type&&t.target===this._controlWrap&&t.buttons%2!=0)&&this.selectStartPosition.length>0){if(Math.abs(this.selectLatestMovePosition[0]-this.selectStartPosition[0])<=1&&Math.abs(this.selectLatestMovePosition[1]-this.selectStartPosition[1])<=1);else{var o=this.selectLatestMovePosition[0]-this.selectStartPosition[0],i=this.selectLatestMovePosition[1]-this.selectStartPosition[1],r={bId:this.id,action:_.MOVE_SHAPE,data:{pIds:this._selectShapes,offset:[o/this.width,i/this.height]}},n=this._selectShapes.map((function(t){return e._displayList.get(t)}));this._canUndoList.push({type:_.MOVE_SHAPE,shapes:n,offset:[o/this.width,i/this.height]}),this.emit("reportContent",r)}this.selectStartPosition=[],this.selectLatestMovePosition=[],this._controlBox.style.pointerEvents="all"}},r.prototype.releaseMouse=function(){switch(this._toolType){case t.EBoardToolType.ARROW:case t.EBoardToolType.ELLIPSE:case t.EBoardToolType.ERASER:case t.EBoardToolType.FREE_DRAW:case t.EBoardToolType.LINE:case t.EBoardToolType.RECT:case t.EBoardToolType.TEXT:this._currentShape&&(this._currentShape=null,this._temporaryList.clear());break;case t.EBoardToolType.LASER_POINTER:this._laserPointer&&(this._laserPointer=null,this._latestMovePosition=[]);break;case t.EBoardToolType.SELECT:this._selectShape&&(this._selectShape=null,this._selectShapes=[])}this._needUpdateShapeData&&(this.emit("reportContent",this._needUpdateShapeData),this._needUpdateShapeData=null)},r.prototype.clearPainter=function(){this._canvasCtx.clearRect(0,0,this.width,this.height)},r.prototype.clearCachePainter=function(){this._cacheCanvasCtx.clearRect(0,0,this.width,this.height)},r.prototype.clearText=function(){this._textBox.innerHTML=""},r.prototype.drawCacheToMain=function(){this._canvasCtx.drawImage(this._cacheCanvas,0,0)},r.prototype._renderTemporaryCanvas=function(){var t=this;this.clearPainter(),this._temporaryList.forEach((function(e){t._drawToPainter(e)}))},r.prototype._drawToPainter=function(t){t.buildPath(this._canvasCtx,t)},r.prototype.drawToCachePainter=function(t){t.buildPath(this._cacheCanvasCtx,t)},r.prototype._handleShapeAttr=function(t,e){var o=this;return this._createProxySetHandle(t,(function(t,i,r,n){e&&e(t,i,r,n),"props"!==i&&"style"!==i||(t[i]=r,o.clearPainter(),t instanceof U?t.setPosition(t.position[0],t.position[1]):o._drawToPainter(t))}))},r.prototype._createProxySetHandle=function(t,e){return new Proxy(t,{set:function(t,o,i,r){return e(t,o,i,r),Reflect.set(t,o,i,r)}})},r.prototype._setBrushCursor=function(e){this._toolType=e;var o="";switch(e){case t.EBoardToolType.SELECT:case t.EBoardToolType.ARROW:case t.EBoardToolType.LINE:case t.EBoardToolType.RECT:case t.EBoardToolType.ELLIPSE:o="crosshair";break;case t.EBoardToolType.FREE_DRAW:var i=decodeURIComponent("data:image/svg+xml,%3c%3fxml version='1.0' encoding='UTF-8'%3f%3e%3csvg width='32px' height='32px' viewBox='0 0 32 32' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e %3ctitle%3efree-hand%3c/title%3e %3cdefs%3e %3cpath d='M1427.058%2c345.43405 C1427.254%2c345.23905 1427.571%2c345.23905 1427.766%2c345.43405 L1427.766%2c345.43405 L1433.374%2c351.04305 C1433.472%2c351.14005 1433.521%2c351.26805 1433.521%2c351.39605 C1433.521%2c351.52505 1433.472%2c351.65305 1433.374%2c351.75005 L1433.374%2c351.75005 L1423.463%2c361.72705 C1423.369%2c361.82105 1423.242%2c361.87405 1423.109%2c361.87405 L1423.109%2c361.87405 L1417.501%2c361.87405 C1417.224%2c361.87405 1417%2c361.65005 1417%2c361.37305 L1417%2c361.37305 L1417%2c355.76505 C1417%2c355.63205 1417.053%2c355.50505 1417.147%2c355.41105 L1417.147%2c355.41105 Z M1430.546%2c341.94725 C1431.808%2c340.68425 1433.855%2c340.68425 1435.118%2c341.94725 L1435.118%2c341.94725 L1436.862%2c343.69125 C1437.493%2c344.32225 1437.809%2c345.14925 1437.809%2c345.97725 C1437.809%2c346.80425 1437.493%2c347.63225 1436.862%2c348.26325 L1436.862%2c348.26325 L1435.815%2c349.31025 C1435.618%2c349.50725 1435.299%2c349.50725 1435.102%2c349.31025 L1435.102%2c349.31025 L1429.498%2c343.70625 C1429.4%2c343.60825 1429.351%2c343.47925 1429.351%2c343.35025 C1429.351%2c343.22125 1429.4%2c343.09225 1429.498%2c342.99425 L1429.498%2c342.99425 Z' id='path-1'%3e%3c/path%3e %3c/defs%3e %3cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'%3e %3cg transform='translate(-1416.000000%2c -331.000000)'%3e %3cuse stroke='%235A5A67' stroke-width='2' fill='%235A5A67' fill-rule='evenodd' xlink:href='%23path-1'%3e%3c/use%3e %3cuse stroke='white' stroke-width='1' xlink:href='%23path-1'%3e%3c/use%3e %3c/g%3e %3c/g%3e%3c/svg%3e");o='url("data:image/svg+xml;base64,'+btoa(i.split("data:image/svg+xml,")[1])+'") 0 36, crosshair';break;case t.EBoardToolType.ERASER:var r=decodeURIComponent("data:image/svg+xml,%3c%3fxml version='1.0' encoding='UTF-8'%3f%3e%3csvg width='32px' height='32px' viewBox='0 0 32 32' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e %3ctitle%3eeraser%3c/title%3e %3cdefs%3e %3cpath d='M1542.63604%2c401.636491 C1542.64212%2c401.642264 1542.64811%2c401.648114 1542.65404%2c401.654038 L1549.74863%2c408.748632 C1550.12256%2c409.122557 1550.14072%2c409.722967 1549.79008%2c410.11881 L1542.80885%2c417.999142 L1532.31285%2c417.999142 L1529.38519%2c415.711238 C1528.95%2c415.371189 1528.87288%2c414.742739 1529.21293%2c414.307554 C1529.23283%2c414.282078 1529.25396%2c414.257582 1529.27624%2c414.234152 L1541.22228%2c401.672031 C1541.60286%2c401.271816 1542.23583%2c401.255904 1542.63604%2c401.636491 Z' id='path-1'%3e%3c/path%3e %3crect id='path-2' x='1539.73654' y='400.606602' width='14' height='8' rx='1'%3e%3c/rect%3e %3c/defs%3e %3cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd'%3e %3cg transform='translate(-1528.000000%2c -387.000000)'%3e %3cg%3e %3cuse stroke='%235A5A67' stroke-width='2' fill='%235A5A67' fill-rule='evenodd' xlink:href='%23path-1'%3e%3c/use%3e %3cuse stroke='white' stroke-width='1' xlink:href='%23path-1'%3e%3c/use%3e %3c/g%3e %3cg transform='translate(1546.736544%2c 404.606602) rotate(-315.000000) translate(-1546.736544%2c -404.606602) '%3e %3cuse stroke='%235A5A67' stroke-width='2' fill='white' fill-rule='evenodd' xlink:href='%23path-2'%3e%3c/use%3e %3cuse stroke='white' stroke-width='1' xlink:href='%23path-2'%3e%3c/use%3e %3c/g%3e %3c/g%3e %3c/g%3e%3c/svg%3e");o='url("data:image/svg+xml;base64,'+btoa(r.split("data:image/svg+xml,")[1])+'") 3 36, crosshair';break;case t.EBoardToolType.TEXT:o="text";break;case t.EBoardToolType.LASER_POINTER:o="none";break;default:o="default"}this._canvas.style.cursor=o},r.prototype._isPointInShape=function(t,e,o){var i=W({kind:"canvas",props:{width:this.width,height:this.height},style:{}}).el.getContext("2d");return o.buildPath(i,o),0!==i.getImageData(t,e,1,1).data[3]},r.prototype._eraserShape=function(t,e){var o,i=this;if(this._displayList.forEach((function(r){r instanceof q?r.isPointInPath(t,e)&&(o=r):i._isPointInShape(t,e,r)&&(o=r)})),o){this._displayList.delete(o.id);var r={bId:this.id,action:_.DELETE_SHAPE,data:{pIds:[o.id]}};this.emit("reportContent",r),this._canUndoList.push({type:_.DELETE_SHAPE,shapes:[o]}),this.clearCachePainter(),this._displayList.forEach((function(t){i.drawToCachePainter(t)}))}},r.prototype._addInputElement=function(t,e,o){var r=(this.boxWidth-this.width)/2,n=(this.boxHeight-this.height)/2,s=W({kind:"textarea",props:i({},d.TEXT_INPUT_ELEMENT_OPTIONS.props),style:i(i({},d.TEXT_INPUT_ELEMENT_OPTIONS.style),{top:o+n+"px",left:e+r+"px","max-width":this.boxWidth-e+"px","max-height":this.boxHeight-o+"px","white-space":"pre-wrap","box-sizing":"content-box",outline:"none",resize:"none","word-break":"break-all",color:this._textColor,"font-style":this._textStyle,"font-size":this._textSize+"px","font-weight":this._textWeight,"line-height":this._textSize+"px","min-width":this._textSize+"px","min-height":this._textSize+"px"})}).el;return this.createTextInput(s),s},r.prototype._createTextInputAndHandleChange=function(t,e){var o=this,i={},r=this.brushId,n=this._addInputElement(r,t,e);this._textInput=n;var s=this.boxWidth-t;n.onfocus=function(t){t.target.style.border="1px dashed rgba(167, 156, 156,1)"},n.focus(),requestAnimationFrame((function(){return n.focus()})),n.oninput=function(t){var e=t.target.value,i=V(e,{fontSize:o._textSize,fontStyle:o._textStyle,fontWeight:o._textWeight,lineHeight:o._textSize,fontFamily:"customFontFamily, sans-serif, serif, monospace"},s),r=i.width,n=i.height;i.list,t.target.style.width=r+2+"px",t.target.style.height=n+2+"px"},n.onblur=function(r){var s=n.value;if(s){i={text:s,fontSize:o._textSize,lineHeight:o._textSize,x:t,y:e,maxWidth:o.boxWidth-t,maxHeight:o.boxHeight-e};var a=new q(o.brushId,{props:i,style:{textFill:o._textColor,textStyle:o._textStyle,textWeight:o._textWeight}});o.drawToCachePainter(a);var h=o._handleShapeAttr(a);o._displayList.set(a.id,h),o._canUndoList.push({type:_.ADD_SHAPE,shapes:[a]});var c={bId:o.id,action:_.ADD_SHAPE,data:{pId:a.id,width:o.width,height:o.height,shape:a.type,props:a.props,style:a.style,position:a.position,lts:Date.now()}};o.emit("reportContent",c)}n.remove(),o._textInput=null}},r}(it),at=function(){this.type=0,this.fId="#DEFAULT",this.url="",this.title="DEFAULT",this.currentPageIndex=1,this.totalPageCount=1,this.boardList=[],this.width=1920,this.height=1080},ht=function(){this.bId="",this.scale=100,this.ratio="16:9",this.color="#ffffff",this.image="",this.imageFillMode="contain",this.url="",this.pList=new Map,this.canUndoList=[],this.canRedoList=[]},ct=function(){function t(t){if(this._url="",this._wss=!0,this._port=443,this._timeout=6e4,"[object Object]"===Object.prototype.toString.call(t)){var e=t.url,o=t.wss,i=t.port,r=t.timeout;"string"==typeof e&&(this._url=e),"boolean"==typeof o&&(this._wss=o,this._port=o?443:80),"number"==typeof i&&(this._port=i),"number"==typeof r&&(this._timeout=r)}}return t.prototype.setRequestUrl=function(t){if("[object Object]"===Object.prototype.toString.call(t)){var e=t.url,o=t.wss,i=t.port;"string"==typeof e&&(this._url=e),"boolean"==typeof o&&(this._wss=o,this._port=o?443:80),"number"==typeof i&&(this._port=i)}},t.prototype.request=function(t,e,o){return this._sendUrlRequest(t,e,o)},t.prototype.post=function(t,e){return this.request(t,"POST",e)},t.prototype.get=function(t,e){return this.request(t,"GET",e)},t.prototype._sendUrlRequest=function(t,e,o,i){var r=this;return void 0===i&&(i=!0),new Promise((function(n,s){if(""!==r._url){var a=r._url;t&&(a=r._url+t);var h=new XMLHttpRequest;h.timeout=6e4;var c=function(){200===h.status?n(JSON.parse(h.responseText)):s(new et(y))};i&&(h.onreadystatechange=function(t){4===h.readyState&&c()}),h.open(e,a,i),h.onerror=function(t){s(new et(S))},h.ontimeout=function(){s(new et(g))},h.send(JSON.stringify(o)),i||c()}else s("NO_REQUEST_URL")}))},t}(),lt=function(){function t(){this._urls=[],this._urlSuffix="/arapi/v1?action=",this._appid="",this._sessionId="",this._urls=[d.GATEWAY_ADDRESS],this._urlSuffix="/arapi/v1?action="}return t.prototype.joinGateway=function(t){var e=this;void 0===t&&(t={});var o=this;return new Promise((function(s,a){var h=o._urlSuffix.concat("wb_gateway"),c=function(){return r(e,void 0,void 0,(function(){var e,r,l,p,u,_;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,Promise.race(this._urls.map((function(e){return new ct({url:e,timeout:d.GATEWAY_CONNECT_TIMEOUT}).post(h,i({},t))})))];case 1:if(e=n.sent())if(0===(r=e.code))l=e.sessionid,p=t.appId,o._sessionId=l,o._appid=p,s(e);else if(-1===r)setTimeout((function(){c()}),d.GATEWAY_CONNECT_TIMEOUT);else{if(-4===r||-7===r)throw new et(T,"MISSING_PARAMETER");if(13===r)throw new et(A,"DEVELOPER_INVALID");if(14===r)throw new et(m,"UID_BANNED");if(15===r)throw new et(b,"IP_BANNED");if(16===r)throw new et(C,"CHANNEL_BANNED");if(101===r)throw new et(I,"APPID_INVALID");if(102===r)throw new et(D,"SERVER_NOT_OPEN");if(109===r)throw new et(B,"TOKEN_EXPIRED You must request a new token from your server and call join to use the new token to join the channel");if(110===r)throw new et(w,"TOKEN_INVALID make sure token is right and try angain please");setTimeout((function(){c()}),d.GATEWAY_CONNECT_TIMEOUT)}return[3,3];case 2:return u=n.sent(),"NETWORK_ERROR"===(_=u).code||"NETWORK_TIMEOUT"===_.code||"NETWORK_RESPONSE_ERROR"===_.code?(setTimeout((function(){c()}),d.GATEWAY_CONNECT_TIMEOUT),[2]):(a(_),[3,3]);case 3:return[2]}}))}))};c()}))},t}();t.EConnectionState=void 0,($=t.EConnectionState||(t.EConnectionState={}))[$.DISCONNECTED=0]="DISCONNECTED",$[$.CONNECTING=1]="CONNECTING",$[$.RECONNECTING=2]="RECONNECTING",$[$.CONNECTED=3]="CONNECTED",$[$.DISCONNECTING=4]="DISCONNECTING";var dt=function(e){function i(o){var i=e.call(this)||this;if(i._websocket=null,i._url="",i._wss=!0,i._port=443,i.revState=t.EConnectionState.DISCONNECTED,i.curState=t.EConnectionState.DISCONNECTED,i.onclose=function(){},i.onerror=function(){},i.onmessage=function(){},o&&"[object Object]"===Object.prototype.toString.call(o)){var r=o.url,n=o.wss,s=o.port;r&&(i._url=r),"boolean"==typeof n&&(i._wss=n),s&&(i._port=s)}return i}return o(i,e),Object.defineProperty(i.prototype,"connectState",{get:function(){return this._websocket?this._websocket.readyState:WebSocket.CLOSED},enumerable:!1,configurable:!0}),i.prototype.open=function(t){var e=this;return new Promise((function(o,i){if(t&&"[object Object]"===Object.prototype.toString.call(t)){var r=t.url,n=t.wss,s=t.port;r&&(e._url=r),"boolean"==typeof n&&(e._wss=n),s&&(e._port=s)}var a=(e._wss?"wss":"ws")+"://"+e._url+":"+e._port;Q.debug("[ws-client] websocket opened: "+a),e._websocket=new WebSocket(a),e._websocket.onopen=function(){Q.debug("Signaling channel opened. "+a),e._websocket.onerror=function(t){Q.debug("Signaling channel error."),e.onerror(t)},e._websocket.onclose=function(t){Q.debug(e._url+" server closed with code: "+t.code+" reason: "+t.reason),e.onclose(t),e._websocket=null},o()},e._websocket.onmessage=function(t){e.onmessage(t)},e._websocket.onerror=function(t){i(Error("WebSocket error."))}}))},i.prototype.close=function(){this._websocket&&(this._websocket.close(),this._websocket=null)},i.prototype.send=function(t){"object"==typeof t?this._websocket&&1===this._websocket.readyState&&this._websocket.send(JSON.stringify(t)):Q.error("signal channel msg must be object.")},i.prototype.addMessageEventListener=function(t,e){if(this._websocket)return this._websocket.addEventListener("message",t,e)},i.prototype.removeMessageEventListener=function(t,e){if(this._websocket)return this._websocket.removeEventListener("message",t,e)},i.prototype.clear=function(){this.close(),this.onerror=function(){},this.onclose=function(){},this.onmessage=function(){},this.addMessageEventListener=function(){},this.removeMessageEventListener=function(){}},i}(tt),pt=function(t){return t.then((function(t){return[null,t]})).catch((function(t){return[t]}))},ut=function(e){function i(t){var o=e.call(this)||this;o._cmdEncrypt=!1,o._appId="",o._serverIsWss=!0,o._serverUrl="",o._serverPort=0,o._channel=null,o._userId=null,o._connectTimeout=0,o._keepAliveTimeout=0,o._keepALiveInterval=0,o._keepALiveIntervalTime=1e4,o.handleMediaServerEvents=function(){};var i=o;return t&&t.appId&&(i._appId=t.appId),o}return o(i,e),i.prototype.send=function(t){e.prototype.send.call(this,t)},i.prototype.init=function(t){var e=this,o=t.appId,i=t.isWss,r=t.url,n=t.port;o&&(e._appId=o),"boolean"==typeof i&&(e._serverIsWss=i),r&&(e._serverUrl=r),n&&(e._serverPort=n)},i.prototype.setAppInfo=function(t){var e=t.appId;this._appId=e},i.prototype.configServer=function(t,e,o){var i=this;i._serverIsWss=t,i._serverUrl=e,i._serverPort=o},i.prototype.connectServer=function(e,o,i){var s=this,h=this;return new Promise((function(c,l){return r(s,void 0,void 0,(function(){var r,s,d,p;return n(this,(function(n){switch(n.label){case 0:return h._emitConnectionState(t.EConnectionState.CONNECTING),h._setConnectTimeout(),[4,pt(h.open({url:h._serverUrl,wss:h._serverIsWss,port:h._serverPort}))];case 1:return r=a.apply(void 0,[n.sent(),2]),(s=r[0])?(h._clearConnectTimeout(),l(s),[3,4]):[3,2];case 2:return h._clearConnectTimeout(),h._emitConnectionState(t.EConnectionState.CONNECTED),this._channel=e,this._userId=o,[4,pt(this.doInit({appId:h._appId,chanId:e,uId:o,accessToken:i}))];case 3:if(d=a.apply(void 0,[n.sent(),2]),p=d[0])return h._clearConnectTimeout(),l(p),[2];c(),h.onmessage=function(t){var e=t.data,o=JSON.parse(e),i=o.cmd,r=o.data;if(o.errMsg,o.errCode,"CONNECT"===i);else h.handleMediaServerEvents&&h.handleMediaServerEvents(i,r)},h.onerror=function(t){Q.error("board server handle some error ",t)},h.onclose=function(e){var o=e.code,i=e.reason;switch(Q.info("board serve disconnected...",o),h._clearConnectTimeout(),h._clearKeepALiveTimeout(),o){case 1e3:case 1005:h._emitConnectionState(t.EConnectionState.DISCONNECTED,"LEAVE");break;case 3001:h._emitConnectionState(t.EConnectionState.RECONNECTING,"NETWORK_ERROR");break;default:Q.debug("bNode serve disconnected with code "+o+", reason "+i),h.curState!==t.EConnectionState.RECONNECTING&&h._emitConnectionState(t.EConnectionState.RECONNECTING,"SERVER_ERROR")}h.clear()},c(),n.label=4;case 4:return[2]}}))}))}))},i.prototype.doInit=function(t){var e=this;return new Promise((function(o,i){var r=""+Date.now(),n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.INIT&&r===l&&(e.removeMessageEventListener(n),0===c?o():(Q.warning("BOARD_SERVER_INIT_FAILED"),i("BOARD_SERVER_INIT_FAILED")))};e.addMessageEventListener(n);var s={cmd:_.INIT,seqId:r,data:t,rts:r};e.send(s)}))},i.prototype.doGetChannelInfo=function(){var t=this;return new Promise((function(e,o){var i=""+Date.now(),r=function(o){var n=o.data,s=JSON.parse(n),a=s.cmd;s.data,s.errMsg,s.errCode;var h=s.seqId;a===_.CHAN_DATA&&i===h&&(t.removeMessageEventListener(r),e())};t.addMessageEventListener(r);var n={cmd:_.CHAN_DATA,seqId:i,rts:i};t.send(n)}))},i.prototype.doAddFile=function(t,e){var o=this;return new Promise((function(i,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.ADD_FILE&&e===l&&(o.removeMessageEventListener(n),0===c?i():(Q.warning("ADD_FILE_FAILED"),r("ADD_FILE_FAILED")))};o.addMessageEventListener(n);var s={cmd:_.ADD_FILE,seqId:e,rts:e,data:t};o.send(s)}))},i.prototype.doAddBoard=function(t,e){var o=this;return new Promise((function(i,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.ADD_BOARD&&e===l&&(o.removeMessageEventListener(n),0===c?i():(Q.warning("ADD_BOARD_FAILED"),r("ADD_BOARD_FAILED")))};o.addMessageEventListener(n);var s={cmd:_.ADD_BOARD,seqId:e,data:t,rts:e};o.send(s)}))},i.prototype.doDeleteBoard=function(t,e){var o=this;return new Promise((function(i,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.DELETE_BOARD&&e===l&&(o.removeMessageEventListener(n),0===c?i():(Q.warning("DELETE_BOARD_FAILED"),r("DELETE_BOARD_FAILED")))};o.addMessageEventListener(n);var s={cmd:_.DELETE_BOARD,seqId:e,data:t,rts:e};o.send(s)}))},i.prototype.doSwitchBoard=function(t,e){var o=this;return new Promise((function(i,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.SWITCH_BOARD&&e===l&&(o.removeMessageEventListener(n),0===c?i():(Q.warning("SWITCH_BOARD_FAILED"),r("SWITCH_BOARD_FAILED")))};o.addMessageEventListener(n);var s={cmd:_.SWITCH_BOARD,seqId:e,data:t,rts:e};o.send(s)}))},i.prototype.doResetBoard=function(t){var e=this;return new Promise((function(o,i){var r=function(n){var s=n.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.RESET_BOARD&&t===l&&(e.removeMessageEventListener(r),0===c?o():(Q.warning("RESET_BOARD_FAILED"),i("RESET_BOARD_FAILED")))};e.addMessageEventListener(r);var n={cmd:_.RESET_BOARD,seqId:t,rts:t};e.send(n)}))},i.prototype.doClearBoard=function(t,e){var o=this;return new Promise((function(i,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.CLEAR_BOARD&&e===l&&(o.removeMessageEventListener(n),0===c?i():(Q.warning("CLEAR_BOARD_FAILED"),r("CLEAR_BOARD_FAILED")))};o.addMessageEventListener(n);var s={cmd:_.CLEAR_BOARD,seqId:e,data:t,rts:e};o.send(s)}))},i.prototype.doSetBoardRatio=function(t){var e=this;return new Promise((function(o,i){var r=""+Date.now(),n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.BOARD_RATIO&&r===l&&(e.removeMessageEventListener(n),0===c?o():(Q.warning("BOARD_RATIO_FAILED"),i("BOARD_RATIO_FAILED")))};e.addMessageEventListener(n);var s={cmd:_.BOARD_RATIO,seqId:r,rts:r,data:t};e.send(s)}))},i.prototype.doScaleBoard=function(t,e){var o=this;return new Promise((function(i,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.SCALE_BOARD&&e===l&&(o.removeMessageEventListener(n),0===c?i():(Q.warning("SCALE_BOARD_FAILED"),r("SCALE_BOARD_FAILED")))};o.addMessageEventListener(n);var s={cmd:_.SCALE_BOARD,seqId:e,rts:e,data:t};o.send(s)}))},i.prototype.doUpdateBoardBackgroundColor=function(t,e){var o=this;return new Promise((function(i,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.UPDATE_BACKGROUND&&e===l&&(o.removeMessageEventListener(n),0===c?i():(Q.warning("UPDATE_BACKGROUND_FAILED"),r("UPDATE_BACKGROUND_FAILED")))};o.addMessageEventListener(n);var s={cmd:_.UPDATE_BACKGROUND,seqId:e,rts:e,data:t};o.send(s)}))},i.prototype.doUpdateBoardBackgroundImage=function(t){var e=this;return new Promise((function(o,i){var r=""+Date.now(),n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.UPDATE_BACKGROUND_IMAGE&&r===l&&(e.removeMessageEventListener(n),0===c?o():(Q.warning("UPDATE_BACKGROUND_IMAGE_FAILED"),i("UPDATE_BACKGROUND_IMAGE_FAILED")))};e.addMessageEventListener(n);var s={cmd:_.UPDATE_BACKGROUND_IMAGE,seqId:r,rts:r,data:t};e.send(s)}))},i.prototype.doAddShape=function(t,e){var o=this;return new Promise((function(i,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.ADD_SHAPE&&e===l&&(o.removeMessageEventListener(n),0===c?i():(Q.warning("ADD_SHAPE_FAILED"),r("ADD_SHAPE_FAILED")))};o.addMessageEventListener(n);var s={cmd:_.ADD_SHAPE,seqId:e,rts:e,data:t};o.send(s)}))},i.prototype.doMoveShape=function(t,e){var o=this;return new Promise((function(i,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.MOVE_SHAPE&&e===l&&(o.removeMessageEventListener(n),0===c?i():(Q.warning("MOVE_SHAPE_FAILED"),r("MOVE_SHAPE_FAILED")))};o.addMessageEventListener(n);var s={cmd:_.MOVE_SHAPE,seqId:e,rts:e,data:t};o.send(s)}))},i.prototype.doDeleteShape=function(t,e){var o=this;return new Promise((function(i,r){var n=function(t){var s=t.data,a=JSON.parse(s),h=a.cmd;a.data,a.errMsg;var c=a.errCode,l=a.seqId;h===_.DELETE_SHAPE&&e===l&&(o.removeMessageEventListener(n),0===c?i():(Q.warning("DELETE_SHAPE_FAILED"),r("DELETE_SHAPE_FAILED")))};o.addMessageEventListener(n);var s={cmd:_.DELETE_SHAPE,seqId:e,rts:e,data:t};o.send(s)}))},i.prototype.disconnectServer=function(e){var o=this;if(o._clearKeepALiveTimeout(),o.clear(),e)switch(e){case"UID_BANNED":case"TOKEN_INVALID":case"FORCE_OFFLINE":o._emitConnectionState(t.EConnectionState.DISCONNECTED,e)}else o._emitConnectionState(t.EConnectionState.DISCONNECTED,"LEAVE")},i.prototype.clearEventEmitter=function(){this.removeAllListeners()},i.prototype._setConnectTimeout=function(){this._clearConnectTimeout()},i.prototype._clearConnectTimeout=function(){this._connectTimeout&&clearTimeout(this._connectTimeout)},i.prototype._clearKeepALiveTimeout=function(){var t=this;t._keepAliveTimeout&&(clearTimeout(t._keepAliveTimeout),t._keepAliveTimeout=0)},i.prototype._emitConnectionState=function(e,o){e===t.EConnectionState.DISCONNECTED&&Q.debug("[signal] bNode websocket closed, reason: "+o),this.revState=this.curState,this.curState=e,this.handleMediaServerEvents&&this.handleMediaServerEvents("connection-state-change",{curState:this.curState,revState:this.revState,reason:o})},i}(dt),_t={},ft=function(){return function(){var t,e,o=void 0,i=navigator.userAgent,r=i.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];"Chrome"===r[1]&&null!=(o=i.match(/(OPR(?=\/))\/?(\d+)/i))&&(r=o),"Safari"===r[1]&&null!=(o=i.match(/version\/(\d+)/i))&&(r[2]=o[1]),~i.toLowerCase().indexOf("qqbrowser")&&null!=(o=i.match(/(qqbrowser(?=\/))\/?(\d+)/i))&&(r=o),~i.toLowerCase().indexOf("micromessenger")&&null!=(o=i.match(/(micromessenger(?=\/))\/?(\d+)/i))&&(r=o),~i.toLowerCase().indexOf("edge")&&null!=(o=i.match(/(edge(?=\/))\/?(\d+)/i))&&(r=o),~i.toLowerCase().indexOf("trident")&&null!=(o=/\brv[ :]+(\d+)/g.exec(i)||[])&&(r=[null,"IE",o[1]]);var n=void 0;try{for(var a=s([{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}]),h=a.next();!h.done;h=a.next()){var c=h.value;if(c.r.test(navigator.userAgent)){n=c.s;break}}}catch(e){t={error:e}}finally{try{h&&!h.done&&(e=a.return)&&e.call(a)}finally{if(t)throw t.error}}return{name:r[1],version:r[2],os:n}}()},vt=function(){return ft().os};_t.getBrowserInfo=ft,_t.getBrowserOS=vt,_t.isChrome=function(){var t=ft();return t.name&&"Chrome"===t.name},_t.isSafari=function(){var t=ft();return t.name&&"Safari"===t.name},_t.isEdge=function(){var t=ft();return t.name&&"Edge"===t.name},_t.isFireFox=function(){var t=ft();return t.name&&"Firefox"===t.name},_t.isOpera=function(){var t=ft();return t.name&&"OPR"===t.name},_t.isQQBrowser=function(){var t=ft();return t.name&&"QQBrowser"===t.name},_t.isWeChatBrowser=function(){var t=ft();return t.name&&"MicroMessenger"===t.name},_t.isSupportedPC=function(){var t=vt();return"Linux"===t||"Mac OS X"===t||"Mac OS"===t||-1!==t.indexOf("Windows")},_t.isSupportedMobile=function(){var t=vt();return"Android"===t||"iOS"===t},_t.getBrowserVersion=function(){return ft().version},_t.isChromeKernel=function(){return!!navigator.userAgent.match(/chrome\/[\d]./i)},_t.isLegacyChrome=function(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35};var Et,gt=_t.isChrome()&&_t.getBrowserVersion()>=87,yt=function(e){function s(t){var o=e.call(this)||this;o._cmdEncrypt=!1,o._appId="",o._serverIsWss=!0,o._serverUrl="",o._serverPort=0,o._userId=null,o._connectTimeout=0,o._keepAliveTimeout=0,o._keepALiveInterval=0,o._keepALiveIntervalTime=1e4,o.handleMediaServerEvents=function(){};var i=o;return t&&t.appId&&(i._appId=t.appId),o}return o(s,e),s.prototype.init=function(t){var e=this,o=t.appId,i=t.isWss,r=t.url,n=t.port;e._appId=o,"boolean"==typeof i&&(e._serverIsWss=i),r&&(e._serverUrl=r),n&&(e._serverPort=n)},s.prototype.setAppInfo=function(t){var e=t.appId;this._appId=e},s.prototype.configServer=function(t,e,o){var i=this;i._serverIsWss=t,i._serverUrl=e,i._serverPort=o},s.prototype.connectServer=function(){var e=this,o=this;return new Promise((function(i,s){return r(e,void 0,void 0,(function(){var e,r,h,c=this;return n(this,(function(n){switch(n.label){case 0:return o._emitConnectionState(t.EConnectionState.CONNECTING),o._setConnectTimeout(),[4,pt(o.open({url:o._serverUrl,wss:o._serverIsWss,port:o._serverPort}))];case 1:return e=a.apply(void 0,[n.sent(),2]),(r=e[0])?(o._clearConnectTimeout(),s(r)):(h=(o._serverIsWss?"wss":"ws")+"://"+o._serverUrl+":"+o._serverPort,Q.debug("[ws-client] websocket opened: "+h),o._clearConnectTimeout(),o._emitConnectionState(t.EConnectionState.CONNECTED),o.onmessage=function(t){var e=t.data,i=JSON.parse(e),r=i.Cmd;i.Encrypt;var n=i.Content,s=JSON.parse(n);switch(r){case"KeepAlive":o._clearKeepALiveTimeout();break;case"ReqKeepAlive":c.doKeepAlive();break;case"Login":!gt&&o._startKeepAlive();break;default:o.handleMediaServerEvents&&o.handleMediaServerEvents(r,s)}},o.onerror=function(t){Q.error("rtm server handle some error ",t)},o.onclose=function(e){var i=e.code,r=e.reason;switch(Q.info("rtm serve disconnected...",i),o._clearConnectTimeout(),o._stopKeepAlive(),o._clearKeepALiveTimeout(),i){case 1e3:case 1005:o._emitConnectionState(t.EConnectionState.DISCONNECTED,"LEAVE");break;case 3001:o._emitConnectionState(t.EConnectionState.RECONNECTING,"NETWORK_ERROR");break;default:Q.debug("mNode ws serve disconnected with code "+i+", reason "+r),o.curState!==t.EConnectionState.RECONNECTING&&o._emitConnectionState(t.EConnectionState.RECONNECTING,"SERVER_ERROR")}o.clear()},i()),[2]}}))}))}))},s.prototype.doKeepAlive=function(){var e=this,o={Cmd:"KeepAlive"};o.Encrypt=this._cmdEncrypt,o.Content=JSON.stringify({time:Date.now().toString()}),this.send(o),!e._keepAliveTimeout&&(e._keepAliveTimeout=setTimeout((function(){e._stopKeepAlive(),e._clearKeepALiveTimeout(),e.clear(),e._emitConnectionState(t.EConnectionState.RECONNECTING,"KEEP_A_LIVE_TIME_OUT")}),2*e._keepALiveIntervalTime))},s.prototype.doOnline=function(t){var e=this;return new Promise((function(o,r){var n=function(t){var i=t.data,s=JSON.parse(i),a=s.Cmd;s.Encrypt;var h=s.Content,c=JSON.parse(h);if("Login"===a){e.removeMessageEventListener(n);var l=c.Code;if(0===l){var d=c.UserId;e._userId=d,o(d)}else Q.error("user online failure, code => ",l),r(l)}};e.addMessageEventListener(n);var s={Cmd:"Login"};s.AppId=e._appId,s.Encrypt=e._cmdEncrypt;var a=i({},t);gt&&(a.SvrKeepAlive=!0),s.Content=JSON.stringify(a),e.send(s)}))},s.prototype.doOffline=function(){var t=this;return new Promise((function(e,o){var i=function(r){var n=r.data,s=JSON.parse(n),a=s.Cmd;s.Encrypt;var h=s.Content,c=JSON.parse(h);if("Logout"===a){t.removeMessageEventListener(i);var l=c.Code;0===l?e(l):o(l)}};t.addMessageEventListener(i);var r={Cmd:"Logout"};r.Encrypt=t._cmdEncrypt,r.Content="",t.send(r)}))},s.prototype.doJoinChannel=function(t){var e=this;return new Promise((function(o,i){var r=function(t){var n=t.data,s=JSON.parse(n),a=s.Cmd;s.Encrypt;var h=s.Content,c=JSON.parse(h);if("JoinChannel"===a){e.removeMessageEventListener(r);var l=c.Code;c.ChanId,0===l?o():i(l)}};e.addMessageEventListener(r);var n={Cmd:"JoinChannel"};n.Encrypt=e._cmdEncrypt,n.Content=JSON.stringify(Object.assign({ChanId:t})),e.send(n)}))},s.prototype.doSendChannelMsg=function(t,e,o,i){void 0===i&&(i=!1);var r=this;return new Promise((function(n,s){var a=J(),h=function(t){var e=t.data,o=JSON.parse(e),i=o.Cmd;o.Encrypt;var c=o.Content,l=JSON.parse(c);if("SendChannelMsg"===i){var d=l.Code;l.ChanId;var p=l.MsgId;a===p&&(r.removeMessageEventListener(h),0===d?n():s(d))}};r.addMessageEventListener(h);var c={Cmd:"SendChannelMsg"};c.Encrypt=r._cmdEncrypt,c.Content=JSON.stringify(Object.assign({ChanId:e,FromUId:r._userId,MsgId:a,MsgType:t,MsgBody:o,HistoryMsg:i,Desc:""})),r.send(c)}))},s.prototype.disconnectServer=function(e){var o=this;if(o._stopKeepAlive(),o._clearKeepALiveTimeout(),o.clear(),e)switch(e){case"UID_BANNED":case"TOKEN_INVALID":case"FORCE_OFFLINE":o._emitConnectionState(t.EConnectionState.DISCONNECTED,e)}else o._emitConnectionState(t.EConnectionState.DISCONNECTED,"LEAVE")},s.prototype.clearEventEmitter=function(){this.removeAllListeners()},s.prototype._setConnectTimeout=function(){var t=this;t._clearConnectTimeout(),t._connectTimeout=window.setTimeout((function(){t._emitConnectionState("DISCONNECTING","NETWORK_ERROR")}),1e4)},s.prototype._startKeepAlive=function(){var t=this;t._stopKeepAlive(),t.doKeepAlive(),t._keepALiveInterval=setInterval((function(){t.doKeepAlive()}),t._keepALiveIntervalTime)},s.prototype._stopKeepAlive=function(){this._keepALiveInterval&&clearInterval(this._keepALiveInterval)},s.prototype._clearConnectTimeout=function(){this._connectTimeout&&clearTimeout(this._connectTimeout)},s.prototype._clearKeepALiveTimeout=function(){var t=this;t._keepAliveTimeout&&(clearTimeout(t._keepAliveTimeout),t._keepAliveTimeout=0)},s.prototype._emitConnectionState=function(e,o){e===t.EConnectionState.DISCONNECTED&&Q.debug("[signal] mNode websocket closed, reason: "+o),this.revState=this.curState,this.curState=e,this.handleMediaServerEvents&&this.handleMediaServerEvents("connection-state-change",{curState:this.curState,revState:this.revState,reason:o})},s}(dt),St=function(){function t(t){this.queues=[],this.maxNumber=1/0,t&&(this.maxNumber=t)}return t.prototype.add=function(t){var e,o,i=[];Array.isArray(t)?i=t:i.push(t);try{for(var r=s(i),n=r.next();!n.done;n=r.next()){var a=n.value;if(this.size+1>this.maxNumber)break;this.queues.push(a)}}catch(t){e={error:t}}finally{try{n&&!n.done&&(o=r.return)&&o.call(r)}finally{if(e)throw e.error}}},t.prototype.dequeue=function(){this.queues.length>0&&this.queues.shift()},t.prototype.front=function(){return this.queues.length>0?this.queues[0]:void 0},t.prototype.clear=function(){this.queues=[]},Object.defineProperty(t.prototype,"isEmpty",{get:function(){return 0===this.queues.length},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this.queues.length},enumerable:!1,configurable:!0}),t}(),Tt=function(e){function i(o,i,r,n){var s=e.call(this)||this;return s._appId="",s._uId="",s._channel="",s._token="",s._rtmSignal=void 0,s._boardSignal=void 0,s._connectState=t.EConnectionState.DISCONNECTED,s._reportBoardDataTimer=void 0,s._reportItem=void 0,s._reportQueue=new St,s._reportLts=0,s._appId=o,s._uId=i,s._channel=r,s._token=n,s._gateWay=new lt,s}return o(i,e),Object.defineProperty(i.prototype,"connectState",{get:function(){return this._connectState},enumerable:!1,configurable:!0}),i.prototype.connectServer=function(){return r(this,void 0,void 0,(function(){var e,o,i,r,h,c,l,p,u,_,v,E,g,y,S,T,A,m,b,C,I,D,B,w,L,x,N;return n(this,(function(n){switch(n.label){case 0:return this._connectState!==t.EConnectionState.RECONNECTING&&(this._connectState=t.EConnectionState.CONNECTING),e=new URL(d.GATEWAY_ADDRESS),[4,pt(this._gateWay.joinGateway({appId:this._appId,uid:this._uId,cname:this._channel,token:this._token,cType:0,wss:"https:"===e.protocol}))];case 1:if(o=a.apply(void 0,[n.sent(),2]),i=o[0],r=o[1],i)return[2,Promise.reject(i)];if(h=r.code,c=r.accessToken,l=r.addresses,p=r.boardAddr,u=r.sessionid,0!==h)return[3,19];if(this._boardSignal=new ut({appId:this._appId}),this._boardSignal.handleMediaServerEvents=this._handleBoardServerEvents.bind(this),this._rtmSignal=new yt({appId:this._appId}),this._rtmSignal.handleMediaServerEvents=this._handleRTMServerEvent.bind(this),!(p.length>0&&l.length>0))return[3,18];_=!1,n.label=2;case 2:n.trys.push([2,7,8,9]),v=s(p),E=v.next(),n.label=3;case 3:return E.done?[3,6]:(m=E.value,b=m.addr,C=m.port,I=m.wss,[4,pt(this._connectBoardServer(I,b,C,c))]);case 4:if(g=a.apply(void 0,[n.sent(),2]),!g[0])return _=!0,[3,6];n.label=5;case 5:return E=v.next(),[3,3];case 6:return[3,9];case 7:return y=n.sent(),w={error:y},[3,9];case 8:try{E&&!E.done&&(L=v.return)&&L.call(v)}finally{if(w)throw w.error}return[7];case 9:if(!_)return Q.info("服务连接断开，准备重连中...."),this._connectState=t.EConnectionState.RECONNECTING,this.reconnectServer("BOARD_SERVER_ERROR"),[2,Promise.reject(new et(R,"connect bNode failed"))];S=!1,n.label=10;case 10:n.trys.push([10,15,16,17]),T=s(l),A=T.next(),n.label=11;case 11:return A.done?[3,14]:(m=A.value,b=m.addr,C=m.port,I=m.wss,[4,pt(this._connectRTMServer(I,b,C,u,c))]);case 12:if(D=a.apply(void 0,[n.sent(),2]),!D[0])return S=!0,[3,14];n.label=13;case 13:return A=T.next(),[3,11];case 14:return[3,17];case 15:return B=n.sent(),x={error:B},[3,17];case 16:try{A&&!A.done&&(N=T.return)&&N.call(T)}finally{if(x)throw x.error}return[7];case 17:return S?(this._connectState=t.EConnectionState.CONNECTED,this.emit(f.CONNECTION_STATE_CHANGE,this._connectState,""),Q.info("auth gateway success. begin get channel info..."),this._boardSignal.doGetChannelInfo(),[3,19]):(Q.info("服务连接断开，准备重连中...."),this._connectState=t.EConnectionState.RECONNECTING,this.reconnectServer("RTM_SERVER_ERROR"),[2,Promise.reject(new et(R,"connect mNode failed"))]);case 18:return[2,Promise.reject(new et(O))];case 19:return[2]}}))}))},i.prototype.disconnectServer=function(e){var o,i;this._connectState=t.EConnectionState.DISCONNECTING,null===(o=this._boardSignal)||void 0===o||o.disconnectServer(e),null===(i=this._rtmSignal)||void 0===i||i.disconnectServer(e),this._boardSignal.handleMediaServerEvents=function(){},this._rtmSignal.handleMediaServerEvents=function(){},this._boardSignal=void 0,this._rtmSignal=void 0,this._reportItem=void 0,this._connectState=t.EConnectionState.DISCONNECTED,this.emit(f.CONNECTION_STATE_CHANGE,this._connectState,e||"")},i.prototype.reconnectServer=function(e){var o,i,r=this;this._connectState=t.EConnectionState.RECONNECTING,null===(o=this._boardSignal)||void 0===o||o.disconnectServer(e),null===(i=this._rtmSignal)||void 0===i||i.disconnectServer(e),this._boardSignal.handleMediaServerEvents=function(){},this._rtmSignal.handleMediaServerEvents=function(){},this._boardSignal=void 0,this._rtmSignal=void 0,this._reportItem=void 0,setTimeout((function(){r.emit(f.CONNECTION_STATE_CHANGE,r._connectState,e),Q.debug("reconnect server... "),r.connectServer()}),6e3)},i.prototype.report=function(t){this._reportQueue.add(t),this._checkAndAutoStartQueue()},i.prototype._checkAndAutoStartQueue=function(){!this._reportBoardDataTimer&&this._reportQueue.size>0&&(this._reportBoardDataTimer=requestAnimationFrame(this._reportBoardData.bind(this)))},i.prototype._reportBoardData=function(e){return r(this,void 0,void 0,(function(){var o,i,r,s,a,h;return n(this,(function(n){switch(n.label){case 0:return this._connectState!==t.EConnectionState.CONNECTED?[3,27]:this._reportQueue.size>0?(o=this._reportQueue.front(),this._reportItem===o?[3,25]:(this._reportItem=o,i=o.type,r=o.data,s=o.rts,a=o.callback,h=[],i!==_.ADD_FILE?[3,2]:[4,pt(this._boardSignal.doAddFile(r,s))])):[3,26];case 1:return h=n.sent(),[3,24];case 2:return i!==_.ADD_SHAPE?[3,4]:[4,pt(this._boardSignal.doAddShape(r,s))];case 3:return h=n.sent(),[3,24];case 4:return i!==_.MOVE_SHAPE?[3,6]:[4,pt(this._boardSignal.doMoveShape(r,s))];case 5:return h=n.sent(),[3,24];case 6:return i!==_.DELETE_SHAPE?[3,8]:[4,pt(this._boardSignal.doDeleteShape(r,s))];case 7:return h=n.sent(),[3,24];case 8:return i!==_.ADD_BOARD?[3,10]:[4,pt(this._boardSignal.doAddBoard(r,s))];case 9:return(h=n.sent())[0]||a&&a(),[3,24];case 10:return i!==_.DELETE_BOARD?[3,12]:[4,pt(this._boardSignal.doDeleteBoard(r,s))];case 11:return(h=n.sent())[0]||a&&a(),[3,24];case 12:return i!==_.SWITCH_BOARD?[3,14]:[4,pt(this._boardSignal.doSwitchBoard(r,s))];case 13:return(h=n.sent())[0]||a&&a(),[3,24];case 14:return i!==_.SCALE_BOARD?[3,16]:[4,pt(this._boardSignal.doScaleBoard(r,s))];case 15:return(h=n.sent())[0]||a&&a(),[3,24];case 16:return i!==_.CLEAR_BOARD?[3,18]:[4,pt(this._boardSignal.doClearBoard(r,s))];case 17:return(h=n.sent())[0],[3,24];case 18:return i!==_.RESET_BOARD?[3,20]:[4,pt(this._boardSignal.doResetBoard(s))];case 19:return(h=n.sent())[0]||a&&a(),[3,24];case 20:return i!==_.UPDATE_BACKGROUND?[3,22]:[4,pt(this._boardSignal.doUpdateBoardBackgroundColor(r,s))];case 21:return(h=n.sent())[0]||a&&a(),[3,24];case 22:return i!==_.UPDATE_BACKGROUND_IMAGE?[3,24]:[4,pt(this._boardSignal.doUpdateBoardBackgroundImage(r))];case 23:(h=n.sent())[0]||a&&a(),n.label=24;case 24:h[0]||this._reportQueue.dequeue(),n.label=25;case 25:return this._reportLts=e,[3,27];case 26:if(e-this._reportLts>3e3)return cancelAnimationFrame(this._reportBoardDataTimer),this._reportBoardDataTimer=void 0,this._reportItem=void 0,this._reportLts=0,[2];n.label=27;case 27:return requestAnimationFrame(this._reportBoardData.bind(this)),[2]}}))}))},i.prototype._handleBoardServerEvents=function(e,o){if("connection-state-change"===e){var i=o.curState,r=o.reason;o.revState,Q.debug("board connection-state-change ",i),i===t.EConnectionState.RECONNECTING&&this._connectState!==t.EConnectionState.RECONNECTING&&(this._reportBoardDataTimer&&(this._reportQueue.clear(),this._reportItem=void 0,cancelAnimationFrame(this._reportBoardDataTimer)),this.reconnectServer(r))}else this.emit(e,o)},i.prototype._handleRTMServerEvent=function(e,o){if("connection-state-change"===e){var i=o.curState,r=o.reason;o.revState,Q.debug("rtm connection-state-change ",i),i===t.EConnectionState.RECONNECTING&&this._connectState!==t.EConnectionState.RECONNECTING&&(this._reportBoardDataTimer&&(this._reportQueue.clear(),this._reportItem=void 0,cancelAnimationFrame(this._reportBoardDataTimer)),this.reconnectServer(r))}else"ForceOffline"===e?(this._reportBoardDataTimer&&(this._reportQueue.clear(),this._reportItem=void 0,cancelAnimationFrame(this._reportBoardDataTimer)),this.disconnectServer("FORCE_OFFLINE")):this.emit(e,o)},i.prototype._connectBoardServer=function(e,o,i,s){return r(this,void 0,void 0,(function(){return n(this,(function(r){return this._boardSignal.configServer(e,o,i),this._connectState===t.EConnectionState.CONNECTING||this._connectState===t.EConnectionState.RECONNECTING?[2,this._boardSignal.connectServer(this._channel,this._uId,s)]:[2]}))}))},i.prototype._connectRTMServer=function(t,e,o,i,s){return r(this,void 0,void 0,(function(){var a=this;return n(this,(function(h){switch(h.label){case 0:return this._rtmSignal.configServer(t,e,o),[4,this._rtmSignal.connectServer().then((function(){return r(a,void 0,void 0,(function(){var t;return n(this,(function(e){switch(e.label){case 0:return t={UserId:this._uId,UserSId:"",AcsToken:s,SdkVer:"",SessionId:i},[4,this._rtmSignal.doOnline(t)];case 1:return[2,e.sent()]}}))}))})).then((function(){return r(a,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,this._rtmSignal.doJoinChannel(this._channel)];case 1:return[2,t.sent()]}}))}))}))];case 1:return[2,h.sent()]}}))}))},i}(tt);function At(t){var e=t.trim();if(/^#([0-9a-f]{3}|[0-9a-f]{6})$|^rgb\(\s*(\d+%?)\s*,\s*(\d+%?)\s*,\s*(\d+%?)\s*\)$|^rgba\(\s*(\d+%?)\s*,\s*(\d+%?)\s*,\s*(\d+%?)\s*,\s*(0|1|0?\.\d+)\s*\)$|^hsl\(\s*(\d+)\s*,\s*(\d+%?)\s*,\s*(\d+%?)\s*\)$|^hsla\(\s*(\d+)\s*,\s*(\d+%?)\s*,\s*(\d+%?)\s*,\s*(0|1|0?\.\d+)\s*\)$|^transparent$/i.test(e))return!0;var o=document.createElement("div");return o.style.color=e,""!==o.style.color}t.EBoardImageStatus=void 0,(Et=t.EBoardImageStatus||(t.EBoardImageStatus={}))[Et.BOARD_IMAGE_STATUS_LOADING=1]="BOARD_IMAGE_STATUS_LOADING",Et[Et.BOARD_IMAGE_STATUS_LOAD_DONE=2]="BOARD_IMAGE_STATUS_LOAD_DONE",Et[Et.BOARD_IMAGE_STATUS_LOAD_ABORT=3]="BOARD_IMAGE_STATUS_LOAD_ABORT",Et[Et.BOARD_IMAGE_STATUS_LOAD_ERROR=4]="BOARD_IMAGE_STATUS_LOAD_ERROR",Et[Et.BOARD_IMAGE_STATUS_LOAD_TIMEOUT=5]="BOARD_IMAGE_STATUS_LOAD_TIMEOUT",Et[Et.BOARD_IMAGE_STATUS_LOAD_CANCEL=6]="BOARD_IMAGE_STATUS_LOAD_CANCEL";var mt={id:"",channel:"",appId:"",userId:"",token:"",baseParams:{scale:100,toolType:t.EBoardToolType.FREE_DRAW,progressBarUrl:d.LOADING_ICON,imageResourceTimeout:d.BOARD_IMAGE_RESOURCE_TIMEOUT},styleParams:{textStyle:t.EBoardTextStyle.NORMAL,textSize:16,textColor:"#333333",brushColor:"#333333",brushThin:5,globalBackgroundColor:d.BOARD_BACKGROUND_COLOR,selectBoxColor:d.BOARD_SELECT_STYLE.strokeStyle},authParams:{drawEnable:!0,progressEnable:!1}},bt=function(e){function s(o){var r=e.call(this)||this;r.uid="",r._appid="",r._channel="",r._token="",r._fileId="#DEFAULT",r._fileList=new Map,r._boardId="",r._fileBoardData=new Map,r._curMaxBoardPage=1,r._renderFrameRate=5,r._initConfig=mt,r._fusionServer=void 0;var n=o.id,s=o.channel,a=o.appId,h=o.userId,c=o.token,l=o.baseParams,d=o.styleParams,p=o.serverParams,u=o.authParams;if("string"!=typeof n||0===n.length)throw new et(t.EBoardErrorCode.INVALID_PARAMS,"id must be string.");if(!("string"==typeof a&&a.length>0))throw new et(t.EBoardErrorCode.INVALID_PARAMS,"appId is invalid.");if(r._appid=a,!("string"==typeof s&&s.length>0))throw new et(t.EBoardErrorCode.INVALID_PARAMS,"channel must be string.");if(r._channel=s,!("string"==typeof h&&h.length>0))throw new et(t.EBoardErrorCode.INVALID_PARAMS,"userId must be string.");if(r.uid=h,c){if("string"!=typeof c)throw new et(t.EBoardErrorCode.INVALID_PARAMS,"token must be string.");r._token=c||""}var _=i(i({},mt.baseParams),l),f=i(i({},mt.styleParams),d),v=i(i({},mt.authParams),u);return p&&"{}"!==JSON.stringify(p)&&r._setParameters(p),r._initConfig=i(i({},o),{baseParams:_,styleParams:f,authParams:v}),r._initPainter(n,r._initConfig),r._joinChannel(),r}return o(s,e),Object.defineProperty(s.prototype,"_currentBoardPage",{get:function(){var t=this._fileList.get(this._fileId);return t?t.currentPageIndex:1},set:function(t){var e=this._fileList.get(this._fileId);e&&(e.currentPageIndex=t)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"_totalBoardCount",{get:function(){var t=this._fileList.get(this._fileId);return t?t.totalPageCount:1},set:function(t){var e=this._fileList.get(this._fileId);e&&(e.totalPageCount=t)},enumerable:!1,configurable:!0}),s.prototype[f.ADD_BOARD]=function(t,e){},s.prototype[f.DELETE_BOARD]=function(t,e){},s.prototype[f.GOTO_BOARD]=function(t,e){},s.prototype[f.SCALE_BOARD]=function(t,e){},s.prototype[f.CAN_UNDO_STATUS_CHANGE]=function(t){},s.prototype[f.CAN_REDO_STATUS_CHANGE]=function(t){},s.prototype[f.CONNECTION_STATE_CHANGE]=function(t,e){},s.prototype[f.BOARD_BACKGROUND_COLOR_CHANGE]=function(t,e,o){},s.prototype[f.IMAGE_STATUS_CHANGED]=function(t,e,o,i){},s.prototype[f.CLEAR_BOARD]=function(t,e,o){},s.prototype[f.RESET_BOARD]=function(){},s.prototype[f.ERROR]=function(t,e){},s.prototype[f.WARNING]=function(t,e){},s.prototype.getVersion=function(){return d.SDK_VERSION},s.prototype.destroy=function(){this._leaveChannel()},s.prototype._setParameters=function(t){var e=t.ConfPriCloudAddr,o=t.ConfPriCloudAddr1;if(Q.debug("set parameters config as "+JSON.stringify(t)),e){var i=e.ServerAdd,r=e.Port,n=!0;"boolean"==typeof(s=e.Wss)&&(n=s),d.GATEWAY_ADDRESS_SSL!==n&&(d.GATEWAY_ADDRESS_SSL=n),d.GATEWAY_ADDRESS1&&(d.GATEWAY_ADDRESS1=""),i&&(d.GATEWAY_ADDRESS=(n?"https://"+i:"http://"+i)+(r?":"+r:""))}if(o){var s;i=o.ServerAdd,r=o.Port,n=!0;"boolean"==typeof(s=o.Wss)&&(n=s),d.GATEWAY_ADDRESS_SSL!==n&&(d.GATEWAY_ADDRESS_SSL=n),i&&(d.GATEWAY_ADDRESS1=(n?"https://"+i:"http://"+i)+(r?":"+r:""))}},s.prototype.setBoardStyleParams=function(t){var e=this._initConfig;e.baseParams;var o=e.styleParams;if(Object.assign(o,t),o&&"{}"===JSON.stringify(o)){var i=o.textSize,r=o.textColor,n=o.brushColor,s=o.brushThin,a=o.selectBoxColor,h=o.globalBackgroundColor;i&&"number"!=typeof i&&(o.textSize=16),"string"!=typeof r&&(o.textColor="#333333"),"string"!=typeof n&&(o.brushColor="#333333"),s&&"number"!=typeof s&&s<5&&(o.brushThin=5),"string"!=typeof a&&(o.selectBoxColor="#eeeeee"),"string"!=typeof h&&(o.globalBackgroundColor="#ffffff")}},s.prototype.setBackgroundColor=function(e){var o;if(!At(e))throw new et(t.EBoardErrorCode.INVALID_PARAMS,"The background color is invalid.");if(this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED){var i={bId:this._boardId,color:e};null===(o=this._fusionServer)||void 0===o||o.report({type:_.UPDATE_BACKGROUND,data:i,rts:""+Date.now(),callback:function(){}}),this._setBoardBGColor(this._boardId,i.color)}},s.prototype.getBackgroundColor=function(){var t=this._fileBoardData.get(this._boardId);return null==t?void 0:t.color},s.prototype.setGlobalBackgroundColor=function(e){var o;if(!At(e))throw new et(t.EBoardErrorCode.INVALID_PARAMS,"The background color is invalid.");this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED&&(null===(o=this._fusionServer)||void 0===o||o.report({type:_.UPDATE_BACKGROUND,data:{bId:this._boardId,color:e},rts:""+Date.now()}),this._setGlobalBoardBGColor(e))},s.prototype.getGlobalBackgroundColor=function(){return this._initConfig.styleParams.globalBackgroundColor||""},s.prototype.setBackgroundImage=function(e,o){var i;return void 0===o&&(o="contain"),r(this,void 0,void 0,(function(){return n(this,(function(r){switch(r.label){case 0:if(!["contain","cover","fill"].includes(o))throw new et(t.EBoardErrorCode.INVALID_PARAMS,'The image fill mode must be one of "fill", "contain", or "cover".');return[4,this._setBoardBGImage(this._boardId,e,o)];case 1:return r.sent(),this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED&&(null===(i=this._fusionServer)||void 0===i||i.report({type:_.UPDATE_BACKGROUND_IMAGE,data:{bId:this._boardId,image:e,imageFillMode:o},rts:""+Date.now()})),[2]}}))}))},s.prototype.getBackgroundImage=function(){var t=this._fileBoardData.get(this._boardId);return null==t?void 0:t.image},s.prototype.getBackgroundImageFillMode=function(){var t=this._fileBoardData.get(this._boardId);return(null==t?void 0:t.imageFillMode)||"contain"},s.prototype.getCurrentFileId=function(){return this._fileId},s.prototype.getCurrentBoardId=function(){return this._boardId},s.prototype.getUndoStatus=function(){},s.prototype.getFileInfo=function(t){return this._fileList.get(t)},s.prototype.addBoard=function(){var e;if("#DEFAULT"!==this._fileId){var o=new et(t.EBoardErrorCode.INVALID_OPERATION,"This file not allow to add a new board.");throw Q.error(o),o}var i="web_"+this.uid+"_"+Date.now()+"_"+(this._curMaxBoardPage+1)+"_"+this._fileId;if(Q.info("local add board: "+i),this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED){var r={bId:i,color:this._initConfig.styleParams.globalBackgroundColor,image:"",url:"",scale:100};null===(e=this._fusionServer)||void 0===e||e.report({type:_.ADD_BOARD,data:r,rts:""+Date.now(),callback:function(){}}),this._addBoard(r.bId)}},s.prototype.deleteBoard=function(e){var o;if("#DEFAULT"!==this._fileId){var i=new et(t.EBoardErrorCode.INVALID_OPERATION,"The file does not allow deleting the whiteboard.");throw Q.error(i),i}if(1===this._currentBoardPage){i=new et(t.EBoardErrorCode.INVALID_OPERATION,"The default whiteboard page cannot be deleted.");throw Q.error(i),i}if(e&&"string"!=typeof e){i=new et(t.EBoardErrorCode.INVALID_PARAMS,"The boardId parameter must be string.");throw Q.error(i),i}var r=e||this._boardId;Q.info("local delete board: "+r);var n=this._fileBoardData.get(r);if(n){var s=n.bId;this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED&&(null===(o=this._fusionServer)||void 0===o||o.report({type:_.DELETE_BOARD,data:{bIds:[s]},rts:""+Date.now(),callback:function(){}}),this._deleteBoard([s]))}else Q.error("Error: Can not find the board id is "+e+".")},s.prototype.getBoardList=function(){var t=[];return this._fileList.forEach((function(e){t.push.apply(t,h([],a(e.boardList)))})),t},s.prototype.getFileBoardList=function(t){var e=this._fileList.get(t);return e?e.boardList:[]},s.prototype.setBoardScale=function(e){var o;if("number"!=typeof e){var i=new et(t.EBoardErrorCode.INVALID_PARAMS,"The scale parameter must be number.");throw Q.error(i),i}e>=100&&this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED&&(null===(o=this._fusionServer)||void 0===o||o.report({type:_.SCALE_BOARD,data:{bId:this._boardId,scale:e},rts:""+Date.now(),callback:function(){}}),this._scaleBoard(this._boardId,e))},s.prototype.getBoardScale=function(){var t=this._fileBoardData.get(this._boardId);return(null==t?void 0:t.scale)||100},s.prototype.prevBoard=function(){var e,o=this;if(1!==this._currentBoardPage&&this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED){var i=this._currentBoardPage-1,r=this._fileList.get(this._fileId).boardList[i-1];null===(e=this._fusionServer)||void 0===e||e.report({type:_.SWITCH_BOARD,data:{bId:r},rts:""+Date.now(),callback:function(){}}),o._gotoBoard(r),Q.info("switch to page "+o._currentBoardPage),o._renderCurrentPainter()}},s.prototype.nextBoard=function(){var e,o=this;if(!(this._currentBoardPage>=this._totalBoardCount)&&this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED){var i=this._currentBoardPage+1,r=this._fileList.get(this._fileId).boardList[i-1];null===(e=this._fusionServer)||void 0===e||e.report({type:_.SWITCH_BOARD,data:{bId:r},rts:""+Date.now(),callback:function(){}}),o._gotoBoard(r),Q.info("switch to page "+o._currentBoardPage),o._renderCurrentPainter()}},s.prototype.gotoBoard=function(e){var o,i=this;if(this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED)null===(o=this._fusionServer)||void 0===o||o.report({type:_.SWITCH_BOARD,data:{bId:e},rts:""+Date.now(),callback:function(){}}),i._gotoBoard(e),Q.info("switch to page "+i._currentBoardPage),i._renderCurrentPainter();else{var r=new et(t.EBoardErrorCode.INVALID_OPERATION,"Make sure you are connected to the whiteboard service.");Q.warning(r)}},s.prototype.reset=function(){var e;if(this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED)null===(e=this._fusionServer)||void 0===e||e.report({type:_.RESET_BOARD,data:void 0,rts:""+Date.now(),callback:function(){}}),this._resetBoard(),this.emit(f.RESET_BOARD);else{var o=new et(t.EBoardErrorCode.INVALID_OPERATION,"Make sure you are connected to the whiteboard service.");Q.warning(o)}},s.prototype.getBoardSnapshot=function(){var t;return null===(t=this._painter)||void 0===t?void 0:t.getSnapShortImage()},s.prototype.setEnable=function(e){if("boolean"!=typeof e){var o=new et(t.EBoardErrorCode.INVALID_PARAMS,"The enable parameter must be boolean.");throw Q.warning(o),o}this._painter.setEnable(e)},s.prototype.getEnable=function(){return this._painter.getEnable()},s.prototype.setBrushColor=function(t){var e;null===(e=this._painter)||void 0===e||e.setBrushColor(t)},s.prototype.getBrushColor=function(){return this._painter.brushColor},s.prototype.setBrushType=function(t){var e;null===(e=this._painter)||void 0===e||e.setBrushType(t)},s.prototype.getBrushType=function(){var t;return null===(t=this._painter)||void 0===t?void 0:t.brushType},s.prototype.setBrushThin=function(t){var e;null===(e=this._painter)||void 0===e||e.setBrushThin(t)},s.prototype.getBrushThin=function(){return this._painter.brushThin},s.prototype.setTextColor=function(e){var o;if(!At(e))throw new et(t.EBoardErrorCode.INVALID_PARAMS,"The text color is invalid.");null===(o=this._painter)||void 0===o||o.setTextColor(e)},s.prototype.getTextColor=function(){var t;return null===(t=this._painter)||void 0===t?void 0:t.getTextColor()},s.prototype.setTextSize=function(e){var o;if("number"!=typeof e)throw new et(t.EBoardErrorCode.INVALID_PARAMS,"The size must be number.");null===(o=this._painter)||void 0===o||o.setTextSize(e)},s.prototype.getTextSize=function(){var t;return null===(t=this._painter)||void 0===t?void 0:t.getTextSize()},s.prototype.resize=function(){var t,e=this;null===(t=this._painter)||void 0===t||t.renderSize();var o=this._fileBoardData.get(this._boardId);o&&(this._painter.clear(!0),o.pList.forEach((function(t){e._convertBrushDataAndRenderToBoard(t)})),this._painter.renderControlBox())},s.prototype._clearBackground=function(){var t,e=this._fileBoardData.get(this._boardId);this._painter.clearBackground(),e.color=null===(t=this._initConfig.styleParams)||void 0===t?void 0:t.globalBackgroundColor,e.image="",e.imageFillMode="contain",e.url=""},s.prototype.clear=function(e){var o,i=this._fileBoardData.get(this._boardId);if(e&&this._clearBackground(),this._painter.clearAll(),i.pList.clear(),this.emit(f.CLEAR_BOARD,this._fileId,this._boardId,!!e),this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED)null===(o=this._fusionServer)||void 0===o||o.report({type:_.CLEAR_BOARD,data:{bId:this._boardId,bg:!!e},rts:""+Date.now()});else{var r=new et(t.EBoardErrorCode.INVALID_OPERATION,"Make sure you are connected to the whiteboard service.");Q.warning(r)}},s.prototype.undo=function(){var t;this._painter.canUndoList.length>0&&(null===(t=this._painter)||void 0===t||t.undo())},s.prototype.redo=function(){var t;this._painter.canRedoList.length>0&&(null===(t=this._painter)||void 0===t||t.redo())},s.prototype._joinChannel=function(){return r(this,void 0,void 0,(function(){var e,o,i,r=this;return n(this,(function(n){switch(n.label){case 0:return(e=new Tt(this._appid,this.uid,this._channel,this._token)).on("connection-state-change",(function(e,o){r.emit(f.CONNECTION_STATE_CHANGE,e,o),t.EConnectionState.CONNECTED})),e.on("RecvMsgFromPeer",this._handleP2PMsg.bind(this)),e.on("RecvMsgFromChan",this._handleChannelMsg.bind(this)),this._fusionServer=e,[4,pt(e.connectServer())];case 1:if(o=a.apply(void 0,[n.sent(),1]),i=o[0]){switch(i.code){case T:this.emit(f.ERROR,t.EBoardErrorCode.INIT_ERROR,T);break;case A:case m:case b:case C:case I:case D:case w:case B:this.emit(f.ERROR,t.EBoardErrorCode.AUTH_FAILED,i.code)}return[2]}return[2]}}))}))},s.prototype._leaveChannel=function(){var e;this._fusionServer&&this._fusionServer.connectState===t.EConnectionState.CONNECTED&&(null===(e=this._fusionServer)||void 0===e||e.disconnectServer(),this._fusionServer=void 0,this.emit(f.CONNECTION_STATE_CHANGE,t.EConnectionState.DISCONNECTED,"")),this._fileList.clear(),this._fileId="",this._initConfig=mt,this._fileBoardData.clear(),this._channel="",this._token="",this._appid="",this.uid="",this._boardId="",this._curMaxBoardPage=1,this._painter.setEnable(!1),this._painter.clearAll(),this._painter.destroy(),this.removeAllListeners()},s.prototype.on=function(t,o){e.prototype.on.call(this,t,o)},s.prototype._initPainter=function(e,o){var s,a=this;if(!this._painter){if(!e)throw new et(t.EBoardErrorCode.INVALID_PARAMS);var h=o.baseParams,c=o.styleParams,l=i(i({ratio:"16:9",scale:100},h),c);this._painter=new st(e,l),(null===(s=this._initConfig.authParams)||void 0===s?void 0:s.progressEnable)&&this._painter.showLoading(),this._painter.setEnable(!1),this._painter.setBrushType(l.toolType),setInterval((function(){var t,e,o=a._painter.getNeedUpdateShapeData();if(o)if(o.action===_.ADD_SHAPE){var r=o.data;a._saveToBoardBrushData(o.bId,r),null===(t=a._fusionServer)||void 0===t||t.report({type:o.action,data:i(i({},r),{bId:o.bId}),rts:""+Date.now()})}else if(o.action===_.MOVE_SHAPE){var n=o.data,s=n.pIds,h=n.offset;null===(e=a._fusionServer)||void 0===e||e.report({type:o.action,data:i(i({},o.data),{bId:o.bId}),rts:""+Date.now()});var c=a._fileBoardData.get(o.bId);c&&c.pList.forEach((function(t){if(s.includes(t.pId)){var e=[t.width*h[0],t.height*h[1]];t.position=e}}))}}),1e3/this._renderFrameRate),this._painter.on("reportContent",(function(t){return r(a,void 0,void 0,(function(){var e,o,r,s,a,h,c,l,d,p,u,v,E;return n(this,(function(n){return t&&(t.action===_.ADD_SHAPE?(e=t.data,null===(d=this._fusionServer)||void 0===d||d.report({type:t.action,data:i(i({},e),{bId:t.bId}),rts:""+Date.now()}),this._saveToBoardBrushData(t.bId,e)):t.action===_.DELETE_SHAPE?(null===(p=this._fusionServer)||void 0===p||p.report({type:t.action,data:i(i({},t.data),{bId:t.bId}),rts:""+Date.now()}),o=t.data.pIds,(r=this._fileBoardData.get(t.bId))&&r.pList.forEach((function(t){var e=t.pId;~o.indexOf(e)&&r.pList.delete(e)}))):t.action===_.MOVE_SHAPE&&(s=t.data,a=s.pIds,h=s.offset,null===(u=this._fusionServer)||void 0===u||u.report({type:t.action,data:i(i({},t.data),{bId:t.bId}),rts:""+Date.now()}),(c=this._fileBoardData.get(t.bId))&&c.pList.forEach((function(t){if(a.includes(t.pId)){var e=[t.width*h[0],t.height*h[1]];t.position=[t.position[0]+e[0],t.position[1]+e[1]]}})))),t&&((l=this._fileBoardData.get(t.bId)).canUndoList=this._painter.canUndoList,l.canRedoList=this._painter.canRedoList,this.emit(f.CAN_REDO_STATUS_CHANGE,(null===(v=this._painter)||void 0===v?void 0:v.canRedoList.length)>0),this.emit(f.CAN_UNDO_STATUS_CHANGE,(null===(E=this._painter)||void 0===E?void 0:E.canUndoList.length)>0)),[2]}))}))}))}},s.prototype._processChannelInfo=function(t){var e,o,i,r=this,n=t.fId,s=t.fileList;if(0===s.length){var a=Date.now();this._fileId="#DEFAULT",this._currentBoardPage=1,this._totalBoardCount=1,this._boardId="web_"+this.uid+"_"+a+"_"+this._currentBoardPage+"_"+this._fileId;var h=new at;h.boardList=[this._boardId],null===(e=this._fusionServer)||void 0===e||e.report({type:_.ADD_FILE,data:h,rts:""+Date.now()}),this._fileList.set(this._fileId,h);var c=new ht;c.bId=this._boardId="web_"+this.uid+"_"+a+"_1_"+this._fileId,c.scale=(null===(i=null===(o=this._initConfig)||void 0===o?void 0:o.baseParams)||void 0===i?void 0:i.scale)||100,this._fileBoardData.set(this._boardId,c)}else{this._fileId=n,s.forEach((function(t){var e=t.boardList;t.boardList=[],e.forEach((function(e){t.boardList.push(e.bId),e.pList=new Map;var o=new ht;o.bId=e.bId,o.scale=e.scale,o.color=e.color,o.image=e.image,o.imageFillMode=e.imageFillMode,o.url=e.url,r._fileBoardData.set(e.bId,o)})),r._fileList.set(r._fileId,t)}));var l=this._fileList.get(this._fileId),d=l.currentPageIndex,p=l.totalPageCount,u=l.boardList;this._currentBoardPage=d,this._totalBoardCount=p,this._boardId=u[d-1];var f=u[u.length-1].split("_");this._curMaxBoardPage=Number(f[f.length-2])}},s.prototype._processBoardData=function(t){var e=this;t.data.forEach((function(t){Q.debug("convert to board ("+t.bId+") data.");var o=e._fileBoardData.get(t.bId);o&&(o.scale=t.scale,o.url=t.url,o.image=t.image,o.color=t.color,t.pList.forEach((function(t){e._saveToBoardBrushData(o.bId,t)})))}))},s.prototype._calculateScaleProps=function(t,e,o,i){var r=this._painter.width/o;if(t===u.FREE_DRAW||t===u.ARROW){var n=e.points.map((function(t){return[t[0]*r,t[1]*r]}));e.points=n}else t===u.CIRCLE||t===u.LASER_POINTER?(e.cx=e.cx*r,e.cy=e.cy*r):t===u.ELLIPSE?(e.cx*=r,e.cy*=r,e.xr*=r,e.yr*=r):t===u.LINE?(e.x*=r,e.y*=r,e.x1*=r,e.y1*=r):t===u.RECT?(e.x1*=r,e.y1*=r,e.x2*=r,e.y2*=r):t===u.TEXT&&(e.x*=r,e.y*=r,e.fontSize*=r,e.lineHeight*=r)},s.prototype._convertBrushDataToCurrentBoardSize=function(t){var e=JSON.parse(JSON.stringify(t)),o=e.width,i=e.shape,r=e.props,n=this._painter.width/o;if(i===u.FREE_DRAW||i===u.ARROW){var s=r.points.map((function(t){return[t[0]*n,t[1]*n]}));r.points=s}else i===u.LASER_POINTER?(r.cx=r.cx*n,r.cy=r.cy*n):i===u.ELLIPSE?(r.cx*=n,r.cy*=n,r.xr*=n,r.yr*=n):i===u.LINE?(r.x*=n,r.y*=n,r.x1*=n,r.y1*=n):i===u.RECT?(r.x1*=n,r.y1*=n,r.x2*=n,r.y2*=n):i===u.TEXT&&(r.x*=n,r.y*=n,r.fontSize*=n,r.lineHeight*=n,r.maxWidth*=n,r.maxHeight*=n);return e.width=this._painter.width,e.height=this._painter.height,e.position=[e.position[0]*n,e.position[1]*n],e},s.prototype._saveToBoardBrushData=function(t,e){var o=e.shape,i=e.pId,r=e.props;e.position,e.width,e.height;var n=this._fileBoardData.get(t);if(n){var s=n.pList.get(i);if(s)if(o===u.FREE_DRAW){var a=s.props.points,h=r.points;a.map((function(t){return t.toString()})).every((function(t){return h.toString().includes(t)}))||(s.props.points=a.concat(h))}else s.props=r;else n.pList.set(i,e)}},s.prototype._convertBrushDataAndRenderToBoard=function(t){var e=this._painter.width/t.width,o=this._convertBrushDataToCurrentBoardSize(t),r=o.shape,n=o.props,s=o.position,a=o.pId,h=o.style;o.width,o.height;var c=new rt[r](a,{props:n,position:s,style:i(i({},h),{lineWidth:h.lineWidth*e})});this._painter.addElement(c)},s.prototype._renderCurrentPainter=function(){var t=this,e=this._fileBoardData.get(this._boardId);e&&(this._boardId=e.bId,this._painter.id=this._boardId,this._painter.setCanvasBGColor(e.color),this._painter.setCanvasBGImage(e.image,e.imageFillMode),this._painter.scalePainter(e.scale),this._painter.reset(),this._painter.canUndoList=e.canUndoList,this._painter.canRedoList=e.canRedoList,e.pList.forEach((function(e){t._convertBrushDataAndRenderToBoard(e)})))},s.prototype._convertBrushDataToCurrentPainter=function(){},s.prototype._handleP2PMsg=function(t){var e,o;t.ChanId,t.FromUId;var i=t.MsgBody;t.MsgId,t.MsgType;var r=JSON.parse(i),n=r.cmd,s=r.data;if(n===_.CHAN_DATA)this._processChannelInfo(s),this._painter.id=this._boardId,this._painter.uid=this.uid;else if(n===_.CUR_BOARD_DATA){Q.info("get current board data.");var a=r.isFinished;this._processBoardData(r),this._renderCurrentPainter(),a&&((null===(e=this._initConfig.authParams)||void 0===e?void 0:e.progressEnable)&&this._painter.hideLoading(),(null===(o=this._initConfig.authParams)||void 0===o?void 0:o.drawEnable)&&this._painter.setEnable(!0),this.emit(f.DATA_SYNC_COMPLETED))}else n===_.CACHE_BOARD_DATA&&(Q.info("get cache board data."),this._processBoardData(r))},s.prototype._handleChannelMsg=function(t){var e,o,i=this;t.ChanId;var r=t.FromUId,n=t.MsgBody;t.MsgId,t.MsgType;var s=JSON.parse(n),a=s.cmd;s.bId;var h=s.data;if(r!==this.uid)if(a===_.ADD_SHAPE){var c=h.bId,l=h.pId,d=h.shape,p=h.props;if(h.style,h.width,h.height,h.offset,Q.debug("remote user add shape ("+d+" - "+l+")"),m=this._fileBoardData.get(c)){var v=m.pList.get(l);if(v)if(d===u.FREE_DRAW){var E=v.props.points,g=p.points;E.map((function(t){return t.toString()})).every((function(t){return g.toString().includes(t)}))||(v.props.points=E.concat(g))}else v.props=p;else m.pList.set(l,h);c===this._boardId&&(this._painter.clear(),m.pList.forEach((function(t){i._convertBrushDataAndRenderToBoard(t)})))}}else if(a===_.DELETE_SHAPE){var y=h.bId,S=h.pIds;Q.debug("remote user delete shapes: "+S);var T=this._fileBoardData.get(y);if(T){var A=y===this._boardId;A&&(this._painter.clearSelfLaserPoint(),this._painter.clear()),T.pList.forEach((function(t){var e=t.pId;~S.indexOf(e)?T.pList.delete(e):A&&i._convertBrushDataAndRenderToBoard(t)}))}}else if(a===_.MOVE_SHAPE){var m,b=h.bId,C=h.pIds,I=h.offset;Q.debug("remote user move shapes: "+C+", offset: "+I),(m=this._fileBoardData.get(b))&&(this._painter.clearSelfLaserPoint(),this._painter.clear(),m.pList.forEach((function(t){if(~C.indexOf(t.pId)){var e=t.width,o=t.height,r=[I[0]*e,I[1]*o];t.shape===u.LASER_POINTER?t.position=r:(t.position[0]+=r[0],t.position[1]+=r[1])}b===i._boardId&&i._convertBrushDataAndRenderToBoard(t)})))}else if(a===_.FILE_LIST){h.fId,h.fileList.forEach((function(t){var e=new at;e.type=t.type,e.fId=t.fId,e.url=t.url,e.title=t.title,e.currentPageIndex=t.currentPageIndex,e.totalPageCount=t.totalPageCount,e.width=t.width,e.height=t.height,t.boardList.forEach((function(t){e.boardList.push(t.bId);var o=new ht;o.bId=t.bId,o.scale=t.scale,o.color=t.color,o.image=t.image,o.url=t.url,i._fileBoardData.set(t.bId,o)})),i._fileList.set(t.fId,e)}))}else if(a===_.ADD_BOARD){var D=h.bId;Q.debug("remote user add board: "+D),this._painter.releaseMouse(),this._addBoard(D)}else if(a===_.DELETE_BOARD){var B=h.bIds;Q.debug("remote user delete board: "+B),this._painter.releaseMouse(),this._deleteBoard(B)}else if(a===_.SWITCH_BOARD){var w=h.bId;Q.debug("remote user switch to board: "+w),this._painter.releaseMouse(),this._gotoBoard(w)}else if(a===_.SCALE_BOARD){var O=h,R=O.bId,L=O.scale;Q.debug("remote user scale board to "+L),this._painter.releaseMouse(),this._scaleBoard(R,L),this.emit(f.SCALE_BOARD,R,L)}else if(a===_.CLEAR_BOARD){this._painter.releaseMouse();var x=h,N=x.bId,P=x.bg;Q.debug("remote user clear board brush true, clear background "+P);var M=this._fileBoardData.get(N);M&&(M.pList.clear(),M.canUndoList=[],M.canRedoList=[],this._painter.clearAll(),P&&this._clearBackground(),this.emit(f.CLEAR_BOARD,this._fileId,this._boardId,!!P),this.emit(f.CAN_REDO_STATUS_CHANGE,(null===(e=this._painter)||void 0===e?void 0:e.canRedoList.length)>0),this.emit(f.CAN_UNDO_STATUS_CHANGE,(null===(o=this._painter)||void 0===o?void 0:o.canUndoList.length)>0))}else if(a===_.RESET_BOARD)Q.debug("remote user rest board"),this._painter.releaseMouse(),this._resetBoard(),this.emit(f.RESET_BOARD);else if(a===_.UPDATE_BACKGROUND){var k=h.bId,W=h.color;Q.debug("remote user update background color "+W),this._setBoardBGColor(k,W),this.emit(f.BOARD_BACKGROUND_COLOR_CHANGE,this._fileId,this._boardId,W)}else if(a===_.UPDATE_BACKGROUND_IMAGE){var U=h.bId,G=h.image,H=h.imageFillMode;Q.debug("remote user update background image "+G),this._setBoardBGImage(U,G,H)}else _.UPDATE_BACKGROUND_H5},s.prototype._getFileInfo=function(t){var e=this._fileList.get(t);return e||null},s.prototype._addBoard=function(t){var e,o;this._curMaxBoardPage+=1;var i=new ht;i.bId=t,i.color=this._initConfig.styleParams.globalBackgroundColor,this._fileBoardData.set(t,i);var r=this._fileList.get(this._fileId);r.boardList.push(t),this._currentBoardPage=r.boardList.length,this._totalBoardCount=r.boardList.length,this._boardId=t,Q.info("切换到第"+this._currentBoardPage+"页"),this._renderCurrentPainter(),this.emit(f.ADD_BOARD,this._fileId,[t]),this.emit(f.GOTO_BOARD,this._fileId,this._boardId),this.emit(f.CAN_REDO_STATUS_CHANGE,(null===(e=this._painter)||void 0===e?void 0:e.canRedoList.length)>0),this.emit(f.CAN_UNDO_STATUS_CHANGE,(null===(o=this._painter)||void 0===o?void 0:o.canUndoList.length)>0)},s.prototype._deleteBoard=function(t){for(var e,o,i=this._getFileInfo(this._fileId),r=i.boardList.length-1;r>-1;r--){var n=i.boardList[r];t.includes(n)&&(this._fileBoardData.delete(n),i.boardList.splice(r,1),n===this._boardId&&(this._currentBoardPage-=1,this._totalBoardCount=i.boardList.length,Q.info("切换到第"+this._currentBoardPage+"页"),this._boardId=i.boardList[this._currentBoardPage-1],this._renderCurrentPainter(),this.emit(f.GOTO_BOARD,this._fileId,this._boardId),this.emit(f.CAN_REDO_STATUS_CHANGE,(null===(e=this._painter)||void 0===e?void 0:e.canRedoList.length)>0),this.emit(f.CAN_UNDO_STATUS_CHANGE,(null===(o=this._painter)||void 0===o?void 0:o.canUndoList.length)>0)))}this.emit(f.DELETE_BOARD,this._fileId,[t])},s.prototype._gotoBoard=function(t){var e,o,i=this._getFileInfo(this._fileId),r=i.boardList.indexOf(t);this._currentBoardPage=r+1,this._totalBoardCount=i.boardList.length,this._boardId=t,Q.info("切换到第"+this._currentBoardPage+"页, 总页数 "+this._totalBoardCount),this._renderCurrentPainter(),this.emit(f.GOTO_BOARD,this._fileId,this._boardId),this.emit(f.CAN_REDO_STATUS_CHANGE,(null===(e=this._painter)||void 0===e?void 0:e.canRedoList.length)>0),this.emit(f.CAN_UNDO_STATUS_CHANGE,(null===(o=this._painter)||void 0===o?void 0:o.canUndoList.length)>0)},s.prototype._resetBoard=function(){Q.info("board reset success."),this._painter.clearAll();var t=this._getFileInfo(this._fileId);this._fileList.clear();var e=t.boardList[0],o=new ht;o.bId=e,this._boardId=e,this._fileId="#DEFAULT",t.fId=this._fileId,t.boardList=[e],this._fileBoardData.clear(),this._fileBoardData.set(e,o),this._fileList.set(this._fileId,t),this._currentBoardPage=1,this._totalBoardCount=1,this._curMaxBoardPage=1,this._boardId=e,this._renderCurrentPainter()},s.prototype._scaleBoard=function(t,e){var o=this,i=this._fileBoardData.get(t);i&&(i.scale=e),t===this._boardId&&(Q.info("白板缩放至"+e),this._painter.scalePainter(e),this._painter.clear(!0),this._painter.canUndoList=i.canUndoList,this._painter.canRedoList=i.canRedoList,i&&i.pList.forEach((function(t){o._convertBrushDataAndRenderToBoard(t)})),this._painter.renderControlBox())},s.prototype._setBoardBGColor=function(t,e){var o,i=this._fileBoardData.get(t);i&&(i.color=e),t===this._boardId&&(null===(o=this._painter)||void 0===o||o.setCanvasBGColor(e),Q.info("白板背景颜色改变为："+e))},s.prototype._setGlobalBoardBGColor=function(t){var e=this,o=this._getFileInfo(this._fileId);o&&(this._initConfig.styleParams.globalBackgroundColor=t,o.boardList.forEach((function(o){var i,r=e._fileBoardData.get(o);r.color=t,r.bId===e._boardId&&(null===(i=e._painter)||void 0===i||i.setCanvasBGColor(t))})))},s.prototype._setBoardBGImage=function(e,o,i){var r=this;return void 0===i&&(i="contain"),new Promise((function(n,s){var a,h,c,d;if(/^https:\/\//i.test(o)){var p=new Image,u=(a=function(){p.src="",p.onload=function(){},p.onabort=function(){},p.onerror=function(){};var n=new et(l.INVALID_IMAGE_ASSETS,"The image resource request timeout.");Q.error(n),r.emit(f.IMAGE_STATUS_CHANGED,r._fileId,e,t.EBoardImageStatus.BOARD_IMAGE_STATUS_LOAD_TIMEOUT,{imageUrl:o,imageFillMode:i})},h=r._initConfig.baseParams.imageResourceTimeout,c=null,d=function(){c&&(clearTimeout(c),c=null)},c=setTimeout((function(){d(),a&&a()}),h||1e3),d);p.onload=function(s){u();var a=r._fileBoardData.get(e);a&&(a.image=o,a.imageFillMode=i),e===r._boardId&&(r._painter.setCanvasBGImage(o,i),Q.info("白板背景颜色图片改变为："+o)),r.emit(f.IMAGE_STATUS_CHANGED,r._fileId,e,t.EBoardImageStatus.BOARD_IMAGE_STATUS_LOAD_DONE,{imageUrl:o,imageFillMode:i}),n()},p.onabort=function(n){u();var s=new et(l.INVALID_IMAGE_ASSETS,"The image resource request aborted.");Q.error(s),r.emit(f.IMAGE_STATUS_CHANGED,r._fileId,e,t.EBoardImageStatus.BOARD_IMAGE_STATUS_LOAD_ABORT,{imageUrl:o,imageFillMode:i})},p.onerror=function(n){u();var s=new et(l.INVALID_IMAGE_ASSETS,"The image resource request error.");Q.error(s),r.emit(f.IMAGE_STATUS_CHANGED,r._fileId,e,t.EBoardImageStatus.BOARD_IMAGE_STATUS_LOAD_ERROR,{imageUrl:o,imageFillMode:i})},p.src=o,r.emit(f.IMAGE_STATUS_CHANGED,r._fileId,e,t.EBoardImageStatus.BOARD_IMAGE_STATUS_LOADING,{imageUrl:o,imageFillMode:i})}else s(new et(t.EBoardErrorCode.INVALID_PARAMS,"imageUrl must be https or http files."))}))},s.prototype._setBoardH5=function(t,e){var o=this._fileBoardData.get(t);o&&(o.url=e),t===this._boardId&&(this._painter.setCanvasBGH5(e),Q.info("白板背景颜色图片改变为："+e))},s}(tt);t.ArWhiteBoard=bt,t.default=bt,Object.defineProperty(t,"__esModule",{value:!0})}));
